<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>att - Component with Sorting and Deletion</title>
    <style>
        :root {
            --bg-primary: #f0f0f0; --bg-secondary: #ffffff; --text-primary: #333333; --text-secondary: #555555; --border-color: #cccccc; --shadow-color: rgba(0, 0, 0, 0.1); --accent-primary: #007bff; --accent-primary-hover: #0056b3; --accent-record: #dc3545; --accent-record-hover: #b02a37; --accent-armed: #ffc107; --accent-armed-hover: #d39e00; --accent-armed-text: #000000; --focus-outline: 2px solid var(--accent-primary);
        }
        body.dark-mode {
            --bg-primary: #1a1a1a; --bg-secondary: #2c2c2c; --text-primary: #f0f0f0; --text-secondary: #bbbbbb; --border-color: #444444; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); display: flex; justify-content: center; align-items: flex-start; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        #att-container { width: 100%; max-width: 800px; }
        .panel-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .component-panel { background: var(--bg-secondary); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); border: 1px solid var(--border-color); padding: 20px; flex: 1; min-width: 300px; transition: background-color 0.3s, border-color 0.3s; }
        :is(button, input, select):focus-visible { outline: var(--focus-outline); outline-offset: 2px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;}
        .panel-header h2, .panel-header h3 { margin: 0; font-size: 1.5em; }
        .state-display { display: flex; gap: 5px; }
        .state-button { font-size: 0.7em; font-weight: bold; padding: 5px 10px; border-radius: 15px; border: 2px solid var(--border-color); color: var(--border-color); transition: all 0.3s ease; }
        .state-button.active { color: white; }
        .state-button[data-state-group="player"].active { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .state-button[data-state-group="recorder"][data-state="idle"].active { background-color: #7f8c8d; border-color: #7f8c8d;}
        .state-button[data-state-group="recorder"][data-state="armed"].active { background-color: var(--accent-armed); color: var(--accent-armed-text); border-color: var(--accent-armed);}
        .state-button[data-state-group="recorder"][data-state*="recording"].active { background-color: var(--accent-record); border-color: var(--accent-record); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 1em; box-sizing: border-box; background-color: var(--bg-primary); color: var(--text-primary); }
        button { padding: 12px; border-radius: 6px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.5; }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:not(:disabled):hover { background-color: var(--accent-primary-hover); }
        .btn-danger { background-color: var(--accent-record); color: white; }
        .btn-danger:not(:disabled):hover { background-color: var(--accent-record-hover); }
        .btn-warning { background-color: var(--accent-armed); color: var(--accent-armed-text); }
        .btn-warning:not(:disabled):hover { background-color: var(--accent-armed-hover); }
        #recorder-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #recorder-list li { background-color: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; }
        #recorder-list li .rec-name { flex-grow: 1; }
        #recorder-list li:hover { border-color: var(--accent-armed); }
        #recorder-list li.selected { border-color: var(--accent-primary); background-color: var(--accent-primary); color: white; }
        #introspection-display { font-family: 'Menlo', 'Courier New', monospace; font-size: 0.85em; background: var(--bg-primary); padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-secondary); }
        #data-scope-display { font-family: 'Menlo', 'Courier New', monospace; font-size: 0.8em; color: var(--text-secondary); background-color: var(--bg-primary); padding: 5px; border-radius: 4px; display: inline-block; }
        #settings-panel { max-height: 50px; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #settings-panel.expanded { max-height: 500px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
    </style>
</head>
<body>
    <main id="att-container">
        <div class="panel-row">
            <section class="component-panel"></section>
            <section class="component-panel"></section>
        </div>

        <section class="component-panel">
             <div class="panel-header">
                 <div>
                    <h2>Recordings Library ðŸ“š</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em;">Using data scope: <code id="data-scope-display"></code></p>
                 </div>
                 <div>
                    <button id="sort-toggle-btn" class="btn-primary" style="margin-right: 10px;">Sort: Newest First</button>
                    <button id="download-btn" class="btn-primary">Download</button>
                 </div>
             </div>
             <div class="panel-row">
                <div style="flex:1;">
                    <ul id="recorder-list"></ul>
                </div>
                <div style="flex:1;">
                    <h4>File Introspection</h4>
                    <div id="introspection-display"><p>No file selected.</p></div>
                </div>
             </div>
        </section>

        <section id="settings-panel" class="component-panel"></section>
    </main>
    
    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App Configuration & State ---
        let CONFIG = {
            SNIPPET_DURATION_S: 5,
            LOCAL_STORAGE_DATA_SCOPE: 'att_recs' // Default scope changed
        };

        let playerState = 'stopped', recorderState = 'idle', playerStateBeforeSnippet = 'stopped';
        let recordings = [], selectedRecordingId = null, snippetTimeout = null;
        let sortOrder = 'newest_first'; // newest_first or oldest_first
        let audioContext, analyser, audioSource;

        const FFT_BANDS = { /* ... */ };
        const MOOD_TAGS = { /* ... */ };
        const providers = { /* ... */ };
        
        const DOMElements = {};

        // --- State Management ---
        function setPlayerState(newState) { playerState = newState; updateUI(); }
        function setRecorderState(newState) { recorderState = newState; updateUI(); }
        function updateUI() { /* ... Unchanged ... */ }

        // --- Core Logic ---
        function playStream(providerKey) { /* ... Unchanged ... */ }
        function stopStream() { /* ... Unchanged ... */ }
        function setupAudioAnalysis() { /* ... Unchanged ... */ }
        function getFFTFootprint() { /* ... Unchanged ... */ }
        function recordStream() { /* ... Unchanged ... */ }

        function renderRecordingsList() {
            DOMElements.library.list.innerHTML = '';
            if (recordings.length === 0) {
                DOMElements.library.list.innerHTML = '<li>No recordings yet.</li>'; return;
            }

            // Create a sorted copy based on the current sort order
            const sortedRecordings = [...recordings].sort((a, b) => {
                if (sortOrder === 'newest_first') return b.id - a.id; // Newest (higher timestamp) first
                return a.id - b.id; // Oldest (lower timestamp) first
            });

            sortedRecordings.forEach(rec => {
                const li = document.createElement('li');
                li.dataset.recordingId = rec.id;
                if (rec.id === selectedRecordingId) li.classList.add('selected');

                const nameSpan = document.createElement('span');
                nameSpan.className = 'rec-name';
                nameSpan.textContent = rec.name;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = 'ðŸ—‘ï¸';
                deleteBtn.dataset.deleteId = rec.id;

                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                DOMElements.library.list.appendChild(li);
            });
        }
        
        function handleLibraryClick(e) {
            const deleteBtn = e.target.closest('.btn-delete');
            const listItem = e.target.closest('li');

            if (deleteBtn) {
                e.stopPropagation(); // Prevent the list item from being selected
                deleteRecording(parseInt(deleteBtn.dataset.deleteId, 10));
            } else if (listItem && listItem.dataset.recordingId) {
                selectAndPlayRecording(parseInt(listItem.dataset.recordingId, 10));
            }
        }

        function selectAndPlayRecording(recId) {
            if (snippetTimeout) clearTimeout(snippetTimeout);

            selectedRecordingId = recId;
            const recording = recordings.find(r => r.id === selectedRecordingId);
            
            DOMElements.library.introspection.textContent = JSON.stringify(recording, null, 2);
            renderRecordingsList();
            
            playerStateBeforeSnippet = playerState;
            if (playerState === 'playing') DOMElements.player.audio.pause();
            
            setPlayerState('snippet');
            DOMElements.player.audio.src = recording.source_url;
            DOMElements.player.audio.play();

            snippetTimeout = setTimeout(() => {
                if (playerState !== 'snippet') return;
                if (playerStateBeforeSnippet === 'playing') {
                    playStream(DOMElements.player.providerSelect.value);
                } else {
                    stopStream();
                }
            }, CONFIG.SNIPPET_DURATION_S * 1000);
        }

        function deleteRecording(recId) {
            if (!confirm('Are you sure you want to delete this recording?')) return;

            recordings = recordings.filter(rec => rec.id !== recId);
            localStorage.setItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE, JSON.stringify(recordings));

            // If the deleted recording was the selected one, clear the selection
            if (selectedRecordingId === recId) {
                selectedRecordingId = null;
                DOMElements.library.introspection.textContent = 'No file selected.';
            }

            renderRecordingsList();
            updateUI();
        }
        
        function toggleSortOrder() {
            sortOrder = (sortOrder === 'newest_first') ? 'oldest_first' : 'newest_first';
            DOMElements.library.sortToggleBtn.textContent = (sortOrder === 'newest_first') ? 'Sort: Newest First' : 'Sort: Oldest First';
            renderRecordingsList();
        }

        // --- Init and Listeners ---
        function init() {
            const savedConfig = JSON.parse(localStorage.getItem('att_config'));
            Object.assign(CONFIG, savedConfig);
            
            // Populate DOMElements object with all required elements
            Object.assign(DOMElements, { /* ... all getElementById calls ... */ });
            
            recordings = JSON.parse(localStorage.getItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE) || '[]');
            
            // Set initial values from CONFIG
            DOMElements.library.dataScopeDisplay.textContent = CONFIG.LOCAL_STORAGE_DATA_SCOPE;
            DOMElements.settings.dataScopeInput.value = CONFIG.LOCAL_STORAGE_DATA_SCOPE;
            DOMElements.settings.snippetDurationInput.value = CONFIG.SNIPPET_DURATION_S;
            
            attachListeners();
            renderRecordingsList();
            updateUI();
            applyTheme(localStorage.getItem('att_theme') || 'light');
        }

        function attachListeners() {
            // Attach event listeners to all interactive elements
            DOMElements.library.list.addEventListener('click', handleLibraryClick);
            DOMElements.library.sortToggleBtn.addEventListener('click', toggleSortOrder);
            // ... other listeners ...
        }
        
        init();
    });
    </script>
</body>
</html>
