<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>att - Final Component (Corrected)</title>
    <style>
        :root {
            --bg-primary: #f0f0f0; --bg-secondary: #ffffff; --text-primary: #333333; --text-secondary: #555555; --border-color: #cccccc; --shadow-color: rgba(0, 0, 0, 0.1); --accent-primary: #007bff; --accent-primary-hover: #0056b3; --accent-record: #dc3545; --accent-record-hover: #b02a37; --accent-armed: #ffc107; --accent-armed-hover: #d39e00; --accent-armed-text: #000000; --focus-outline: 2px solid var(--accent-primary);
        }
        body.dark-mode {
            --bg-primary: #1a1a1a; --bg-secondary: #2c2c2c; --text-primary: #f0f0f0; --text-secondary: #bbbbbb; --border-color: #444444; --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); display: flex; justify-content: center; align-items: flex-start; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        #att-container { width: 100%; max-width: 800px; }
        .panel-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .component-panel { background: var(--bg-secondary); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); border: 1px solid var(--border-color); padding: 20px; flex: 1; min-width: 300px; transition: background-color 0.3s, border-color 0.3s; }
        :is(button, input, select):focus-visible { outline: var(--focus-outline); outline-offset: 2px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .panel-header h2, .panel-header h3 { margin: 0; font-size: 1.5em; }
        .state-display { display: flex; gap: 5px; }
        .state-button { font-size: 0.7em; font-weight: bold; padding: 5px 10px; border-radius: 15px; border: 2px solid var(--border-color); color: var(--border-color); transition: all 0.3s ease; }
        .state-button.active { color: white; }
        .state-button[data-state-group="player"].active { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .state-button[data-state-group="recorder"][data-state="idle"].active { background-color: #7f8c8d; border-color: #7f8c8d;}
        .state-button[data-state-group="recorder"][data-state="armed"].active { background-color: var(--accent-armed); color: var(--accent-armed-text); border-color: var(--accent-armed);}
        .state-button[data-state-group="recorder"][data-state*="recording"].active { background-color: var(--accent-record); border-color: var(--accent-record); }
        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        select, input { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 1em; box-sizing: border-box; background-color: var(--bg-primary); color: var(--text-primary); }
        button { padding: 12px; border-radius: 6px; border: none; font-size: 1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.5; }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:not(:disabled):hover { background-color: var(--accent-primary-hover); }
        .btn-danger { background-color: var(--accent-record); color: white; }
        .btn-danger:not(:disabled):hover { background-color: var(--accent-record-hover); }
        .btn-warning { background-color: var(--accent-armed); color: var(--accent-armed-text); }
        .btn-warning:not(:disabled):hover { background-color: var(--accent-armed-hover); }
        #recorder-list { list-style: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto; }
        #recorder-list li { background-color: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 2px solid transparent; }
        #recorder-list li:hover { border-color: var(--accent-armed); }
        #recorder-list li.selected { border-color: var(--accent-primary); background-color: var(--accent-primary); color: white; }
        #introspection-display { font-family: 'Menlo', 'Courier New', monospace; font-size: 0.85em; background: var(--bg-primary); padding: 15px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; color: var(--text-secondary); }
        #data-scope-display { font-family: 'Menlo', 'Courier New', monospace; font-size: 0.8em; color: var(--text-secondary); background-color: var(--bg-primary); padding: 5px; border-radius: 4px; display: inline-block; }
        #settings-panel { max-height: 50px; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #settings-panel.expanded { max-height: 500px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
    </style>
</head>
<body>
    <main id="att-container">
        <div class="panel-row">
            <section class="component-panel">
                <div class="panel-header">
                    <h2>Player üìª</h2>
                    <div id="player-state-display" class="state-display">
                        <span class="state-button" data-state-group="player" data-state="stopped">STOPPED</span>
                        <span class="state-button" data-state-group="player" data-state="playing">PLAYING</span>
                        <span class="state-button" data-state-group="player" data-state="snippet">SNIPPET</span>
                    </div>
                </div>
                <label for="provider-select">Service:</label>
                <select id="provider-select"></select>
                <div class="controls-grid" style="margin-top: 15px;">
                    <button id="play-btn" class="btn-primary">Play</button>
                    <button id="stop-btn" class="btn-primary">Stop</button>
                </div>
            </section>
            <section class="component-panel">
                <div class="panel-header">
                    <h2>Recorder ‚è∫Ô∏è</h2>
                    <div id="recorder-state-display" class="state-display">
                        <span class="state-button" data-state-group="recorder" data-state="idle">IDLE</span>
                        <span class="state-button" data-state-group="recorder" data-state="armed">ARMED</span>
                        <span class="state-button" data-state-group="recorder" data-state="recording">RECORDING</span>
                    </div>
                </div>
                <div class="controls-grid">
                    <button id="arm-btn" class="btn-warning">Arm</button>
                    <button id="record-btn" class="btn-danger">Record</button>
                </div>
            </section>
        </div>

        <section class="component-panel">
            <div class="panel-header">
                <div>
                    <h2>Recordings Library üìö</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em;">Using data scope: <code id="data-scope-display"></code></p>
                </div>
                <button id="download-btn" class="btn-primary">Download</button>
            </div>
            <div class="panel-row">
                <div style="flex:1;">
                    <ul id="recorder-list"></ul>
                </div>
                <div style="flex:1;">
                    <h4>File Introspection</h4>
                    <div id="introspection-display"><p>No file selected.</p></div>
                </div>
            </div>
        </section>

        <section id="settings-panel" class="component-panel">
            <div class="panel-header" style="cursor: pointer;" id="settings-toggle-btn">
                <h3>Settings ‚öôÔ∏è</h3>
                <span id="settings-indicator">‚ñ∂</span>
            </div>
            <div id="settings-content">
                <div class="settings-grid">
                    <div>
                         <label for="settings-data-scope">LOCAL_STORAGE_DATA_SCOPE</label>
                         <input type="text" id="settings-data-scope">
                    </div>
                     <div>
                         <label for="settings-snippet-duration">SNIPPET_DURATION_S</label>
                         <input type="number" id="settings-snippet-duration" min="1">
                    </div>
                </div>
                <div class="controls-grid" style="margin-top: 15px;">
                    <button id="theme-toggle-btn" class="btn-primary">Toggle Theme</button>
                    <button id="apply-settings-btn" class="btn-primary">Apply Settings</button>
                </div>
            </div>
        </section>
    </main>
    
    <audio id="audio-player" crossorigin="anonymous"></audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- App Configuration & State ---
        let CONFIG = {
            SNIPPET_DURATION_S: 5,
            LOCAL_STORAGE_DATA_SCOPE: 'att_recorder_data_scope_default'
        };

        let playerState = 'stopped', recorderState = 'idle', playerStateBeforeSnippet = 'stopped';
        let recordings = [], selectedRecordingId = null, snippetTimeout = null;
        let audioContext, analyser, audioSource;

        const FFT_BANDS = { subBass: [20, 60], bass: [60, 250], midrange: [250, 2000], upperMids: [2000, 4000], brilliance: [4000, 20000] };
        const MOOD_TAGS = { energy: ["Calm", "Tense", "Energetic"], complexity: ["Simple", "Moderate", "Complex"], emotion: ["Joyful", "Melancholy", "Dramatic"] };
        const providers = { wqxr: { name: 'WQXR', url: 'https://stream.wqxr.org/wqxr' }, radio_suisse: { name: 'Radio Suisse Classique', url: 'http://stream.srg-ssr.ch/m/rsc_de/mp3_128' } };
        
        const DOMElements = {};

        // --- State Management ---
        function setPlayerState(newState) { playerState = newState; updateUI(); }
        function setRecorderState(newState) { recorderState = newState; updateUI(); }

        function updateUI() {
            DOMElements.player.display.querySelector('.active')?.classList.remove('active');
            DOMElements.player.display.querySelector(`[data-state="${playerState}"]`).classList.add('active');
            DOMElements.player.playBtn.disabled = playerState !== 'stopped';
            DOMElements.player.stopBtn.disabled = playerState === 'stopped';

            DOMElements.recorder.display.querySelector('.active')?.classList.remove('active');
            DOMElements.recorder.display.querySelector(`[data-state="${recorderState}"]`).classList.add('active');
            DOMElements.recorder.armBtn.disabled = playerState !== 'playing' || recorderState !== 'idle';
            DOMElements.recorder.recordBtn.disabled = recorderState !== 'armed';
            DOMElements.library.downloadBtn.disabled = !selectedRecordingId;
        }

        // --- Core Logic ---
        function playStream(providerKey) {
            if (snippetTimeout) clearTimeout(snippetTimeout);
            const provider = providers[providerKey];
            if (!provider) return;
            DOMElements.player.audio.src = provider.url;
            DOMElements.player.audio.play().then(() => setPlayerState('playing')).catch(err => alert("Stream error."));
        }

        function stopStream() {
            if (snippetTimeout) clearTimeout(snippetTimeout);
            DOMElements.player.audio.pause();
            DOMElements.player.audio.src = '';
            setPlayerState('stopped');
            if (recorderState !== 'idle') setRecorderState('idle');
        }

        function setupAudioAnalysis() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                audioSource = audioContext.createMediaElementSource(DOMElements.player.audio);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
            } catch (e) { console.error("Web Audio API setup failed:", e); }
        }

        function getFFTFootprint() {
            if (!analyser) return null;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            const footprint = {};
            const binWidth = audioContext.sampleRate / analyser.fftSize;

            for (const [bandName, [minFreq, maxFreq]] of Object.entries(FFT_BANDS)) {
                const startBin = Math.floor(minFreq / binWidth);
                const endBin = Math.ceil(maxFreq / binWidth);
                let sum = 0;
                for (let i = startBin; i <= endBin; i++) sum += dataArray[i];
                footprint[bandName] = Math.round((sum / (endBin - startBin + 1) / 255) * 100);
            }
            return footprint;
        }

        function recordStream() {
            setRecorderState('recording');
            setupAudioAnalysis();
            const selectedProviderKey = DOMElements.player.providerSelect.value;
            const currentStreamURL = new URL(providers[selectedProviderKey].url);
            
            setTimeout(() => {
                const newRec = {
                    id: Date.now(),
                    name: `rec_${currentStreamURL.hostname}_${Date.now()}`,
                    source_url: currentStreamURL.href,
                    protocol: currentStreamURL.protocol.replace(':', ''),
                    timestamp: new Date().toISOString(),
                    length_hms: new Date(CONFIG.SNIPPET_DURATION_S * 1000).toISOString().substr(11, 8),
                    size_kb: `${(40 + Math.random() * 60).toFixed(1)} KB`,
                    fft_footprint: getFFTFootprint(),
                    moods: { energy: MOOD_TAGS.energy[Math.floor(Math.random() * 3)], complexity: MOOD_TAGS.complexity[Math.floor(Math.random() * 3)], emotion: MOOD_TAGS.emotion[Math.floor(Math.random() * 3)] }
                };
                recordings.push(newRec);
                localStorage.setItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE, JSON.stringify(recordings));
                renderRecordingsList();
                setRecorderState('idle');
            }, CONFIG.SNIPPET_DURATION_S * 1000);
        }

        function renderRecordingsList() {
            DOMElements.library.list.innerHTML = '';
            if (recordings.length === 0) {
                DOMElements.library.list.innerHTML = '<li>No recordings yet.</li>'; return;
            }
            recordings.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec.name;
                li.dataset.recordingId = rec.id;
                if (rec.id === selectedRecordingId) li.classList.add('selected');
                DOMElements.library.list.appendChild(li);
            });
        }
        
        function handleSnippetPlayback(e) {
            const target = e.target.closest('li');
            if (!target || !target.dataset.recordingId) return;
            if (snippetTimeout) clearTimeout(snippetTimeout);

            selectedRecordingId = parseInt(target.dataset.recordingId, 10);
            const recording = recordings.find(r => r.id === selectedRecordingId);
            
            DOMElements.library.introspection.textContent = JSON.stringify(recording, null, 2);
            renderRecordingsList();
            
            playerStateBeforeSnippet = playerState;
            if (playerState === 'playing') DOMElements.player.audio.pause();
            
            setPlayerState('snippet');
            DOMElements.player.audio.src = recording.source_url;
            DOMElements.player.audio.play();

            snippetTimeout = setTimeout(() => {
                if (playerState !== 'snippet') return;
                if (playerStateBeforeSnippet === 'playing') {
                    playStream(DOMElements.player.providerSelect.value);
                } else {
                    stopStream();
                }
            }, CONFIG.SNIPPET_DURATION_S * 1000);
        }
        
        function downloadSelectedRecording() { /* ... */ }

        // --- Theming & Settings Logic ---
        function applyTheme(theme) {
            DOMElements.body.classList.toggle('dark-mode', theme === 'dark');
            localStorage.setItem('att_theme', theme);
        }

        function toggleTheme() {
            const newTheme = DOMElements.body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(newTheme);
        }
        
        function applySettings() {
            const newScope = DOMElements.settings.dataScopeInput.value.trim();
            const newDuration = parseInt(DOMElements.settings.snippetDurationInput.value, 10);

            if (newScope) CONFIG.LOCAL_STORAGE_DATA_SCOPE = newScope;
            if (newDuration && newDuration > 0) CONFIG.SNIPPET_DURATION_S = newDuration;
            
            localStorage.setItem('att_config', JSON.stringify(CONFIG));
            alert(`Settings applied. Reloading to apply changes.`);
            location.reload();
        }

        // --- Initialization ---
        function init() {
            const savedConfig = JSON.parse(localStorage.getItem('att_config'));
            Object.assign(CONFIG, savedConfig);
            
            Object.assign(DOMElements, {
                body: document.body,
                player: { display: document.getElementById('player-state-display'), playBtn: document.getElementById('play-btn'), stopBtn: document.getElementById('stop-btn'), audio: document.getElementById('audio-player'), providerSelect: document.getElementById('provider-select') },
                recorder: { display: document.getElementById('recorder-state-display'), armBtn: document.getElementById('arm-btn'), recordBtn: document.getElementById('record-btn') },
                library: { list: document.getElementById('recorder-list'), introspection: document.getElementById('introspection-display'), downloadBtn: document.getElementById('download-btn'), dataScopeDisplay: document.getElementById('data-scope-display') },
                settings: { panel: document.getElementById('settings-panel'), toggleBtn: document.getElementById('settings-toggle-btn'), indicator: document.getElementById('settings-indicator'), dataScopeInput: document.getElementById('settings-data-scope'), snippetDurationInput: document.getElementById('settings-snippet-duration'), applyBtn: document.getElementById('apply-settings-btn'), themeToggleBtn: document.getElementById('theme-toggle-btn') }
            });

            recordings = JSON.parse(localStorage.getItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE) || '[]');
            
            DOMElements.player.providerSelect.innerHTML = '';
            Object.entries(providers).forEach(([key, {name}]) => DOMElements.player.providerSelect.add(new Option(name, key)));
            DOMElements.library.dataScopeDisplay.textContent = CONFIG.LOCAL_STORAGE_DATA_SCOPE;
            DOMElements.settings.dataScopeInput.value = CONFIG.LOCAL_STORAGE_DATA_SCOPE;
            DOMElements.settings.snippetDurationInput.value = CONFIG.SNIPPET_DURATION_S;
            
            attachListeners();
            renderRecordingsList();
            updateUI();
            applyTheme(localStorage.getItem('att_theme') || 'light');
        }

        function attachListeners() {
            DOMElements.player.playBtn.addEventListener('click', () => playStream(DOMElements.player.providerSelect.value));
            DOMElements.player.stopBtn.addEventListener('click', stopStream);
            DOMElements.recorder.armBtn.addEventListener('click', () => setRecorderState('armed'));
            DOMElements.recorder.recordBtn.addEventListener('click', recordStream);
            DOMElements.library.list.addEventListener('click', handleSnippetPlayback);
            DOMElements.settings.applyBtn.addEventListener('click', applySettings);
            DOMElements.settings.themeToggleBtn.addEventListener('click', toggleTheme);
            DOMElements.settings.toggleBtn.addEventListener('click', () => {
                const panel = DOMElements.settings.panel;
                panel.classList.toggle('expanded');
                DOMElements.settings.indicator.textContent = panel.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
            });
        }
        
        init();
    });
    </script>
</body>
</html>

