<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>att - Component with Sorting and Deletion</title>
    <style>
        :root {
            --bg-primary: #f0f0f0;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #555555;
            --border-color: #cccccc;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --accent-primary: #007bff;
            --accent-primary-hover: #0056b3;
            --accent-record: #dc3545;
            --accent-record-hover: #b02a37;
            --accent-armed: #ffc107;
            --accent-armed-hover: #d39e00;
            --accent-armed-text: #000000;
            --focus-outline: 2px solid var(--accent-primary);
        }
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2c2c2c;
            --text-primary: #f0f0f0;
            --text-secondary: #bbbbbb;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        #att-container {
            width: 100%;
            max-width: 800px;
        }
        .panel-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .component-panel {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            flex: 1;
            min-width: 300px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        :is(button, input, select):focus-visible {
            outline: var(--focus-outline);
            outline-offset: 2px;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .panel-header h2, .panel-header h3 {
            margin: 0;
            font-size: 1.5em;
        }
        .state-display {
            display: flex;
            gap: 5px;
        }
        .state-button {
            font-size: 0.7em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
            color: var(--border-color);
            transition: all 0.3s ease;
            user-select: none;
        }
        .state-button.active { color: white; }
        .state-button[data-state-group="player"].active { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .state-button[data-state-group="recorder"][data-state="idle"].active { background-color: #7f8c8d; border-color: #7f8c8d; }
        .state-button[data-state-group="recorder"][data-state="armed"].active { background-color: var(--accent-armed); color: var(--accent-armed-text); border-color: var(--accent-armed); }
        .state-button[data-state-group="recorder"][data-state*="recording"].active { background-color: var(--accent-record); border-color: var(--accent-record); }
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            box-sizing: border-box;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        button {
            padding: 12px;
            border-radius: 6px;
            border: none;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:not(:disabled):hover { background-color: var(--accent-primary-hover); }
        .btn-danger { background-color: var(--accent-record); color: white; }
        .btn-danger:not(:disabled):hover { background-color: var(--accent-record-hover); }
        .btn-warning { background-color: var(--accent-armed); color: var(--accent-armed-text); }
        .btn-warning:not(:disabled):hover { background-color: var(--accent-armed-hover); }
        .btn-delete { background-color: var(--text-secondary); color: white; padding: 5px 10px; font-size: 0.8em; margin-left: 10px; }
        #recorder-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        #recorder-list li {
            background-color: var(--bg-primary);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        #recorder-list li .rec-name { flex-grow: 1; }
        #recorder-list li:hover { border-color: var(--accent-armed); }
        #recorder-list li.selected { border-color: var(--accent-primary); background-color: var(--accent-primary); color: white; }
        #introspection-display {
            font-family: 'Menlo', 'Courier New', monospace;
            font-size: 0.85em;
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-secondary);
        }
        #data-scope-display {
            font-family: 'Menlo', 'Courier New', monospace;
            font-size: 0.8em;
            color: var(--text-secondary);
            background-color: var(--bg-primary);
            padding: 5px;
            border-radius: 4px;
            display: inline-block;
        }
        #settings-panel { max-height: 50px; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        #settings-panel.expanded { max-height: 500px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;}
        /* Hide actual audio player */
        #audio-player { display: none; }
    </style>
</head>
<body>
    <main id="att-container">
        <div class="panel-row">
            <section class="component-panel">
                <div class="panel-header">
                    <h2>Player üìª</h2>
                    <div id="player-state-display" class="state-display">
                        <span class="state-button" data-state-group="player" data-state="stopped">STOPPED</span>
                        <span class="state-button" data-state-group="player" data-state="playing">PLAYING</span>
                        <span class="state-button" data-state-group="player" data-state="snippet">SNIPPET</span>
                    </div>
                </div>
                <label for="provider-select">Service:</label>
                <select id="provider-select"></select>
                <div class="controls-grid" style="margin-top: 15px;">
                    <button id="play-btn" class="btn-primary">Play</button>
                    <button id="stop-btn" class="btn-primary">Stop</button>
                </div>
            </section>
            <section class="component-panel">
                <div class="panel-header">
                    <h2>Recorder ‚è∫Ô∏è</h2>
                    <div id="recorder-state-display" class="state-display">
                        <span class="state-button" data-state-group="recorder" data-state="idle">IDLE</span>
                        <span class="state-button" data-state-group="recorder" data-state="armed">ARMED</span>
                        <span class="state-button" data-state-group="recorder" data-state="recording">RECORDING</span>
                    </div>
                </div>
                <div class="controls-grid">
                    <button id="arm-btn" class="btn-warning">Arm</button>
                    <button id="record-btn" class="btn-danger">Record</button>
                </div>
            </section>
        </div>

        <section class="component-panel">
             <div class="panel-header">
                 <div>
                    <h2>Recordings Library üìö</h2>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em;">Using data scope: <code id="data-scope-display"></code></p>
                 </div>
                 <div>
                    <button id="sort-toggle-btn" class="btn-primary" style="margin-right: 10px;">Sort: Newest First</button>
                    <button id="download-btn" class="btn-primary">Download</button>
                 </div>
             </div>
             <div class="panel-row">
                <div style="flex:1;">
                    <ul id="recorder-list"></ul>
                </div>
                <div style="flex:1;">
                    <h4>File Introspection</h4>
                    <div id="introspection-display"><p>No file selected.</p></div>
                </div>
             </div>
        </section>

        <section id="settings-panel" class="component-panel">
            <div class="panel-header" style="cursor: pointer;" id="settings-toggle-btn">
                <h3>Settings ‚öôÔ∏è</h3>
                <span id="settings-indicator">‚ñ∂</span>
            </div>
            <div id="settings-content" class="settings-panel">
                <div class="settings-grid">
                    <div>
                         <label for="settings-data-scope">LOCAL_STORAGE_DATA_SCOPE</label>
                         <input type="text" id="settings-data-scope">
                    </div>
                     <div>
                         <label for="settings-snippet-duration">SNIPPET_DURATION_S</label>
                         <input type="number" id="settings-snippet-duration" min="1">
                    </div>
                </div>
                <div class="controls-grid" style="margin-top: 15px;">
                    <button id="theme-toggle-btn" class="btn-primary">Toggle Theme</button>
                    <button id="apply-settings-btn" class="btn-primary">Apply Settings</button>
                </div>
            </div>
        </section>
    </main>
    <audio id="audio-player" crossorigin="anonymous"></audio>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Configuration & State
        let CONFIG = {
            SNIPPET_DURATION_S: 5,
            LOCAL_STORAGE_DATA_SCOPE: 'att_recs'
        };
        let playerState='stopped', recorderState='idle', playerStateBeforeSnippet='stopped';
        let recordings=[], selectedRecordingId=null, snippetTimeout=null, sortOrder='newest_first';
        const DOM = {};
        const providers={ wqxr:{name:'WQXR',url:'https://stream.wqxr.org/wqxr'}, radio_suisse:{name:'Radio Suisse',url:'http://stream.srg-ssr.ch/m/rsc_de/mp3_128'} };

        function setPlayerState(s){ playerState=s; updateUI(); }
        function setRecorderState(s){ recorderState=s; updateUI(); }

        function updateUI(){
            DOM.player.display.querySelector('.active')?.classList.remove('active');
            DOM.player.display.querySelector(`[data-state="${playerState}"]`)?.classList.add('active');
            DOM.player.playBtn.disabled=(playerState!=='stopped');
            DOM.player.stopBtn.disabled=(playerState==='stopped');

            DOM.rec.display.querySelector('.active')?.classList.remove('active');
            DOM.rec.display.querySelector(`[data-state="${recorderState}"]`)?.classList.add('active');
            DOM.rec.armBtn.disabled=(playerState!=='playing'||recorderState!=='idle');
            DOM.rec.recordBtn.disabled=(recorderState!=='armed');
            DOM.lib.downloadBtn.disabled=!selectedRecordingId;
        }

        function playStream(key){
            if(snippetTimeout) clearTimeout(snippetTimeout);
            const url=providers[key].url;
            DOM.player.audio.src=url; DOM.player.audio.play().then(()=>setPlayerState('playing'));
        }
        function stopStream(){
            if(snippetTimeout) clearTimeout(snippetTimeout);
            DOM.player.audio.pause(); DOM.player.audio.src=''; setPlayerState('stopped');
            if(recorderState!=='idle') setRecorderState('idle');
        }

        function recordStream(){
            setRecorderState('recording');
            const key=DOM.player.providerSelect.value;
            snippetTimeout=setTimeout(()=>{
                const rec={id:Date.now(),name:`rec_${key}_${Date.now()}`,source_url:providers[key].url,length_s:CONFIG.SNIPPET_DURATION_S};
                recordings.push(rec);
                localStorage.setItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE,JSON.stringify(recordings));
                renderList(); setRecorderState('idle');
            },CONFIG.SNIPPET_DURATION_S*1000);
        }

        function renderList(){
            DOM.lib.list.innerHTML='';
            let arr=[...recordings];
            arr.sort((a,b)=>(sortOrder==='newest_first'?b.id-a.id:a.id-b.id));
            if(arr.length===0) { DOM.lib.list.innerHTML='<li>No recordings yet.</li>'; return; }
            arr.forEach(r=>{
                const li=document.createElement('li'); li.dataset.recordingId=r.id;
                if(r.id===selectedRecordingId) li.classList.add('selected');
                const span=document.createElement('span'); span.className='rec-name'; span.textContent=r.name;
                const delBtn=document.createElement('button'); delBtn.className='btn-delete'; delBtn.textContent='üóëÔ∏è'; delBtn.dataset.deleteId=r.id;
                li.append(span,delBtn); DOM.lib.list.append(li);
            });
        }

        function handleListClick(e){
            const del=e.target.closest('.btn-delete');
            const li=e.target.closest('li');
            if(del){ e.stopPropagation(); deleteRec(+del.dataset.deleteId); }
            else if(li){ selectRec(+li.dataset.recordingId); }
        }
        function selectRec(id){
            selectedRecordingId=id;
            const rec=recordings.find(r=>r.id===id);
            DOM.lib.intros.textContent=JSON.stringify(rec,null,2);
            renderList();
            playerStateBeforeSnippet=playerState;
            if(playerState==='playing') DOM.player.audio.pause();
            setPlayerState('snippet');
            DOM.player.audio.src=rec.source_url;
            DOM.player.audio.play();
            snippetTimeout=setTimeout(()=>{ if(playerState!=='snippet') return; playerStateBeforeSnippet==='playing'?playStream(DOM.player.providerSelect.value):stopStream(); },CONFIG.SNIPPET_DURATION_S*1000);
        }
        function deleteRec(id){ if(!confirm('Delete?')) return; recordings=recordings.filter(r=>r.id!==id); localStorage.setItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE,JSON.stringify(recordings)); if(selectedRecordingId===id){ selectedRecordingId=null; DOM.lib.intros.textContent='No file selected.';} renderList(); updateUI(); }
        function toggleSort(){ sortOrder=(sortOrder==='newest_first'?'oldest_first':'newest_first'); DOM.lib.sortToggleBtn.textContent=(sortOrder==='newest_first'?'Sort: Newest First':'Sort: Oldest First'); renderList(); }

        function applySettings(){
            const scope=DOM.set.dataScope.value.trim(); const dur=+DOM.set.snipDur.value;
            if(scope) CONFIG.LOCAL_STORAGE_DATA_SCOPE=scope;
            if(dur>0) CONFIG.SNIPPET_DURATION_S=dur;
            localStorage.setItem('att_config',JSON.stringify(CONFIG)); location.reload();
        }
        function toggleTheme(){ const dark=document.body.classList.toggle('dark-mode'); localStorage.setItem('att_theme',dark?'dark':'light'); }

        function init(){
            const cfg=JSON.parse(localStorage.getItem('att_config')||'{}'); Object.assign(CONFIG,cfg);
            recordings=JSON.parse(localStorage.getItem(CONFIG.LOCAL_STORAGE_DATA_SCOPE)||'[]');
            Object.assign(DOM,{
                player:{display:document.getElementById('player-state-display'),playBtn:document.getElementById('play-btn'),stopBtn:document.getElementById('stop-btn'),audio:document.getElementById('audio-player'),providerSelect:document.getElementById('provider-select')},
                rec:{display:document.getElementById('recorder-state-display'),armBtn:document.getElementById('arm-btn'),recordBtn:document.getElementById('record-btn')},
                lib:{list:document.getElementById('recorder-list'),intros:document.getElementById('introspection-display'),downloadBtn:document.getElementById('download-btn'),sortToggleBtn:document.getElementById('sort-toggle-btn')},
                set:{dataScope:document.getElementById('settings-data-scope'),snipDur:document.getElementById('settings-snippet-duration'),applyBtn:document.getElementById('apply-settings-btn'),themeBtn:document.getElementById('theme-toggle-btn'),panel:document.getElementById('settings-panel'),toggleBtn:document.getElementById('settings-toggle-btn'),indicator:document.getElementById('settings-indicator')}
            });
            // populate providers
            DOM.player.providerSelect.innerHTML=''; Object.entries(providers).forEach(([k,p])=>DOM.player.providerSelect.add(new Option(p.name,k)));
            document.getElementById('data-scope-display').textContent=CONFIG.LOCAL_STORAGE_DATA_SCOPE;
            DOM.set.dataScope.value=CONFIG.LOCAL_STORAGE_DATA_SCOPE; DOM.set.snipDur.value=CONFIG.SNIPPET_DURATION_S;
            // listeners
            document.getElementById('provider-select').addEventListener('change',e=>{ selectedProvider=e.target.value; updateUI(); });
            DOM.player.playBtn.addEventListener('click',()=>playStream(DOM.player.providerSelect.value));
            DOM.player.stopBtn.addEventListener('click',stopStream);
            DOM.rec.armBtn.addEventListener('click',()=>setRecorderState('armed'));
            DOM.rec.recordBtn.addEventListener('click',recordStream);
            DOM.lib.list.addEventListener('click',handleListClick);
            DOM.lib.sortToggleBtn.addEventListener('click',toggleSort);
            DOM.set.applyBtn.addEventListener('click',applySettings);
            DOM.set.themeBtn.addEventListener('click',toggleTheme);
            DOM.set.toggleBtn.addEventListener('click',()=>{ const p=DOM.set.panel; p.classList.toggle('expanded'); DOM.set.indicator.textContent=p.classList.contains('expanded')?'‚ñº':'‚ñ∂'; });
            // init render
            renderList(); updateUI();
            const savedTheme=localStorage.getItem('att_theme')||'dark'; document.body.classList.toggle('dark-mode',savedTheme==='dark');
        }
        init();
    });
    </script>
</body>
</html>
