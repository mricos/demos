<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Diffusion Manifold Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <style>
    :root { --bg: #05070a; --panel: #0d1117; --border: #21262d; }
    body { background: var(--bg); color: #c9d1d9; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
    canvas { image-rendering: pixelated; border: 1px solid var(--border); background: #000; width: 100%; }
    .stat-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
    .label-text { color: #8b949e; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; }
    .math-block { font-size: 0.8rem; color: #58a6ff; margin-top: 4px; min-height: 1.2em; }
    .sidebar { width: 340px; border-right: 1px solid var(--border); overflow-y: auto; }
  </style>
</head>
<body class="flex">

  <aside class="sidebar p-6 flex flex-col gap-6 bg-[#0d1117]">
    <div>
      <h1 class="text-xl font-bold text-white mb-1">Manifold Lab</h1>
      <p class="text-[10px] text-blue-400 uppercase tracking-widest">Optimal Transport & Blending</p>
    </div>

    <div class="space-y-4">
      <div>
        <span class="label-text">Primary Vector ($P_A$)</span>
        <select id="promptA" class="w-full bg-black border border-gray-700 p-2 rounded mt-1 text-sm">
            <option value="sky">Atmospheric Sky</option>
            <option value="city">Circuit City</option>
            <option value="river" selected>River Valley</option>
            <option value="void">Deep Void</option>
        </select>
      </div>
      <div>
        <span class="label-text">Secondary Vector ($P_B$)</span>
        <select id="promptB" class="w-full bg-black border border-gray-700 p-2 rounded mt-1 text-sm">
            <option value="lava" selected>Lava Flows</option>
            <option value="neon">Neon Grid</option>
            <option value="grass">Green Fields</option>
            <option value="matrix">Binary Matrix</option>
        </select>
      </div>
      
      <div class="stat-card border-blue-900/50 bg-blue-950/10">
        <span class="label-text text-blue-400">Interpolation ($\alpha$)</span>
        <input id="alpha" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full mt-2" />
        <div class="flex justify-between text-[10px] text-gray-500 mt-1">
            <span>Pure $P_A$</span>
            <span>Pure $P_B$</span>
        </div>
      </div>

      <div>
        <span class="label-text">Noise Schedule ($\sigma$)</span>
        <input id="guidance" type="range" min="0.01" max="0.3" step="0.01" value="0.12" class="w-full mt-1" />
      </div>
    </div>

    <div class="flex flex-col gap-2 pt-4 border-t border-gray-800">
      <button id="runBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-sm tracking-tighter">EXECUTE DENOISING</button>
      <button id="resetBtn" class="border border-gray-600 py-2 rounded hover:bg-gray-800 text-xs text-gray-400">FLUSH LATENTS</button>
    </div>
  </aside>

  <main class="flex-1 p-8 overflow-y-auto">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <div class="stat-card lg:col-span-5 border-blue-500/30">
        <span class="label-text">Current Approximation $x_t$</span>
        <div id="math-xt" class="math-block"></div>
        <canvas id="cv_main" class="mt-4 aspect-square"></canvas>
      </div>

      <div class="lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="stat-card">
          <span class="label-text">Manifold Target $m_\alpha$</span>
          <div id="math-mc" class="math-block"></div>
          <canvas id="cv_target"></canvas>
        </div>
        <div class="stat-card">
          <span class="label-text">Vector Field $\nabla \Phi$</span>
          <div id="math-flux" class="math-block"></div>
          <canvas id="cv_flux_map"></canvas>
        </div>
        <div class="stat-card md:col-span-2">
          <span class="label-text">RGB Density Estimation</span>
          <div id="math-px" class="math-block"></div>
          <canvas id="cv_hist" class="h-28 border-0"></canvas>
        </div>
      </div>

    </div>
  </main>

<script>
(() => {
  const W = 64, H = 64, N = W * H;
  
  const LIBRARY = {
    sky: ctx => { ctx.fillStyle = '#38bdf8'; ctx.fillRect(0,0,W,H); },
    city: ctx => { 
        ctx.fillStyle = '#1e293b'; ctx.fillRect(0,0,W,H);
        ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 1;
        for(let i=0; i<W; i+=4) { ctx.strokeRect(i, H-i, 4, i); }
    },
    river: ctx => {
        ctx.fillStyle = '#064e3b'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = '#3b82f6'; ctx.beginPath();
        ctx.moveTo(W/2, 0); ctx.bezierCurveTo(0, H/2, W, H/2, W/2, H); ctx.lineWidth=8; ctx.strokeStyle='#3b82f6'; ctx.stroke();
    },
    lava: ctx => { ctx.fillStyle = '#991b1b'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#f97316'; ctx.fillRect(0,H*0.7,W,H*0.3); },
    neon: ctx => { ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#d946ef'; for(let i=0; i<W; i+=8){ ctx.strokeRect(i,i,W-i*2,H-i*2); } },
    matrix: ctx => { ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#22c55e'; for(let i=0; i<N; i+=12) ctx.fillRect((i%W), Math.floor(i/W), 1, 1); },
    void: ctx => { ctx.fillStyle = '#020617'; ctx.fillRect(0,0,W,H); }
  };

  let x = new Float32Array(N*3), target = new Float32Array(N*3), t = 0, running = false;

  const getCtx = id => { const c = document.getElementById(id); c.width = W; c.height = H; return c.getContext('2d'); };
  const ctxs = {
    main: getCtx('cv_main'), target: getCtx('cv_target'),
    fluxMap: getCtx('cv_flux_map'), hist: getCtx('cv_hist')
  };

  const renderMath = () => {
    const formulas = {
        'math-xt': 'x_{t-1} = x_t + \\eta(m_\\alpha - x_t) + \\sigma \\epsilon',
        'math-mc': 'm_\\alpha = (1-\\alpha)P_A + \\alpha P_B',
        'math-flux': '\\vec{V} = \\nabla \\| x_t - m_\\alpha \\|^2',
        'math-px': 'P(c) \\approx \\frac{1}{N} \\sum \\mathbb{1}_{x_i \\in \\text{bin}_j}'
    };
    Object.entries(formulas).forEach(([id, tex]) => {
        katex.render(tex, document.getElementById(id), { throwOnError: false });
    });
  };

  function getTargetBuffer(key) {
    const off = document.createElement('canvas'); off.width = W; off.height = H;
    const octx = off.getContext('2d');
    if(LIBRARY[key]) LIBRARY[key](octx);
    const data = octx.getImageData(0,0,W,H).data;
    const buf = new Float32Array(N*3);
    for(let i=0; i<N; i++) {
        buf[i*3] = (data[i*4]/127.5)-1;
        buf[i*3+1] = (data[i*4+1]/127.5)-1;
        buf[i*3+2] = (data[i*4+2]/127.5)-1;
    }
    return buf;
  }

  function init() {
    const alpha = parseFloat(document.getElementById('alpha').value);
    const bufA = getTargetBuffer(document.getElementById('promptA').value);
    const bufB = getTargetBuffer(document.getElementById('promptB').value);

    // Manifold Interpolation: Lerp(A, B, alpha)
    for(let i=0; i<N*3; i++) target[i] = (1-alpha)*bufA[i] + alpha*bufB[i];

    renderTargetView();
    for(let i=0; i<N*3; i++) x[i] = (Math.random()*2)-1;
    t = 100; running = true;
    requestAnimationFrame(loop);
  }

  function renderTargetView() {
    const img = ctxs.target.createImageData(W, H);
    for(let i=0; i<N; i++) {
        img.data[i*4] = (target[i*3]+1)*127.5;
        img.data[i*4+1] = (target[i*3+1]+1)*127.5;
        img.data[i*4+2] = (target[i*3+2]+1)*127.5;
        img.data[i*4+3] = 255;
    }
    ctxs.target.putImageData(img, 0, 0);
  }

  function step() {
    if(t <= 0) return running = false;
    const eta = parseFloat(document.getElementById('guidance').value);
    const fluxImg = ctxs.fluxMap.createImageData(W, H);

    for(let i=0; i<N*3; i++) {
        const force = (target[i] - x[i]) * eta;
        const noise = (Math.random()*2-1) * (t/100) * 0.1;
        x[i] += force + noise;
        x[i] = Math.max(-1, Math.min(1, x[i]));

        if(i % 3 === 0) {
            const idx = (i/3)*4;
            fluxImg.data[idx] = Math.abs(force)*1000;
            fluxImg.data[idx+1] = force > 0 ? 255 : 50;
            fluxImg.data[idx+2] = 100;
            fluxImg.data[idx+3] = 255;
        }
    }
    ctxs.fluxMap.putImageData(fluxImg, 0, 0);
    renderMain(); renderHist();
    t--;
  }

  function renderMain() {
    const img = ctxs.main.createImageData(W, H);
    for(let i=0; i<N; i++) {
        img.data[i*4] = (x[i*3]+1)*127.5;
        img.data[i*4+1] = (x[i*3+1]+1)*127.5;
        img.data[i*4+2] = (x[i*3+2]+1)*127.5;
        img.data[i*4+3] = 255;
    }
    ctxs.main.putImageData(img, 0, 0);
  }

  function renderHist() {
    const h = ctxs.hist; h.clearRect(0,0,W,H);
    const bins = [new Array(20).fill(0), new Array(20).fill(0), new Array(20).fill(0)];
    for(let i=0; i<N; i++) {
        for(let c=0; c<3; c++) bins[c][Math.floor(((x[i*3+c]+1)/2)*19.9)]++;
    }
    ['#ef4444', '#22c55e', '#3b82f6'].forEach((col, c) => {
        h.fillStyle = col; h.globalAlpha = 0.4;
        bins[c].forEach((v, i) => h.fillRect(i*(W/20), H, (W/20)-1, -(v/N)*H*4));
    });
  }

  function loop() { if(running) { step(); requestAnimationFrame(loop); } }
  document.getElementById('runBtn').onclick = init;
  document.getElementById('resetBtn').onclick = () => location.reload();
  renderMath();
})();
</script>
</body>
</html>
