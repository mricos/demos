<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toy Texture CA (Gray–Scott) – Vanilla JS SPA</title>
  <style>
    :root { --bg:#0b0f14; --fg:#d7dde6; --muted:#8a93a3; --panel:#101823; --border:#1f2a3a; }
    html,body{height:100%;} body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    header{display:grid;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--panel);}
    .row{display:grid;gap:10px;grid-template-columns:repeat(6,minmax(0,1fr));align-items:end;}
    .row2{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr;}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted);}
    input[type="range"], input[type="number"], select{
      background:#0c121c;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:none;
    }
    input[type="range"]{padding:0;height:26px;}
    button{background:#0c121c;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;}
    main{display:grid;place-items:center;padding:14px;}
    canvas{border:1px solid var(--border);border-radius:12px;background:#000;image-rendering:pixelated;image-rendering:crisp-edges;}
    .meta{margin-top:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;color:var(--muted);font-size:12px;}
    .pill{display:inline-block;margin:0 6px 6px 0;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#0c121c;}
  </style>
</head>
<body>
<header>
  <div class="row2">
    <label>Grid
      <select id="grid">
        <option value="96">96×96</option>
        <option value="128" selected>128×128</option>
        <option value="192">192×192</option>
      </select>
    </label>
    <label>Scale
      <select id="scale">
        <option value="4">4×</option>
        <option value="6" selected>6×</option>
        <option value="8">8×</option>
      </select>
    </label>
    <label>Steps / frame
      <input id="spf" type="number" min="1" max="50" step="1" value="10" />
    </label>
    <label>dt
      <input id="dt" type="number" min="0.1" max="2.0" step="0.05" value="1.0" />
    </label>
    <label>Seed radius
      <input id="seedR" type="number" min="2" max="40" step="1" value="12" />
    </label>
    <label>Seed noise
      <input id="seedNoise" type="range" min="0" max="1" step="0.01" value="0.35" />
    </label>
  </div>

  <div class="row">
    <label>Du
      <input id="Du" type="number" min="0.01" max="2.0" step="0.01" value="0.16" />
    </label>
    <label>Dv
      <input id="Dv" type="number" min="0.01" max="2.0" step="0.01" value="0.08" />
    </label>
    <label>F
      <input id="F" type="number" min="0.0" max="0.12" step="0.0005" value="0.035" />
    </label>
    <label>k
      <input id="k" type="number" min="0.0" max="0.08" step="0.0005" value="0.060" />
    </label>
    <label>Render
      <select id="renderMode">
        <option value="v" selected>palette(v)</option>
        <option value="u">palette(u)</option>
        <option value="vu">palette(v-u)</option>
      </select>
    </label>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="reset">Reset</button>
      <button id="pause">Pause</button>
      <button id="step">Step</button>
    </div>
  </div>
</header>

<main>
  <div style="display:grid;justify-items:center;">
    <canvas id="cv"></canvas>
    <div class="meta" id="meta"></div>
  </div>
</main>

<script>
(() => {
  "use strict";

  // 16-color palette (PICO-8 like), for pixel-art quantization.
  const PAL = [
    [  0,  0,  0], [255,255,255], [ 29, 43, 83], [126, 37, 83],
    [  0,135, 81], [171, 82, 54], [ 95, 87, 79], [194,195,199],
    [255,241,232], [255,  0, 77], [255,163,  0], [255,236, 39],
    [  0,228, 54], [ 41,173,255], [131,118,156], [255,119,168],
  ];
  const PALN = PAL.map(([r,g,b]) => [r/255,g/255,b/255]);

  // DOM
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d", { alpha: false });
  const elGrid = document.getElementById("grid");
  const elScale = document.getElementById("scale");
  const elSpf = document.getElementById("spf");
  const elDt = document.getElementById("dt");
  const elSeedR = document.getElementById("seedR");
  const elSeedNoise = document.getElementById("seedNoise");
  const elDu = document.getElementById("Du");
  const elDv = document.getElementById("Dv");
  const elF = document.getElementById("F");
  const elk = document.getElementById("k");
  const elRenderMode = document.getElementById("renderMode");
  const elMeta = document.getElementById("meta");
  const btnReset = document.getElementById("reset");
  const btnPause = document.getElementById("pause");
  const btnStep = document.getElementById("step");

  // State buffers (ping-pong)
  let N = 128, W = 128, H = 128, size = W*H;
  let u0, v0, u1, v1;
  let img;
  let running = true;

  function alloc(n) {
    N = n; W = n; H = n; size = W*H;
    u0 = new Float32Array(size);
    v0 = new Float32Array(size);
    u1 = new Float32Array(size);
    v1 = new Float32Array(size);
    cv.width = W; cv.height = H;
    const s = Number(elScale.value)|0;
    cv.style.width = (W*s) + "px";
    cv.style.height = (H*s) + "px";
    img = ctx.createImageData(W, H);
  }

  // Toroidal wrap indexing (as used for texture synthesis on a torus).
  function idx(x, y) {
    x = (x + W) % W;
    y = (y + H) % H;
    return y*W + x;
  }

  // 9-point Laplacian (sum weights = 0). Standard Gray–Scott discretization.
  function lap(a, x, y) {
    const c  = a[idx(x,y)];
    const n  = a[idx(x, y-1)];
    const s  = a[idx(x, y+1)];
    const w  = a[idx(x-1, y)];
    const e  = a[idx(x+1, y)];
    const nw = a[idx(x-1, y-1)];
    const ne = a[idx(x+1, y-1)];
    const sw = a[idx(x-1, y+1)];
    const se = a[idx(x+1, y+1)];
    return (0.2*(n+s+w+e) + 0.05*(nw+ne+sw+se) - 1.0*c);
  }

  // Deterministic RNG for seeding (Mulberry32)
  function mulberry32(seed) {
    let a = seed >>> 0;
    return () => {
      a |= 0; a = (a + 0x6D2B79F5) | 0;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function reset(seed = 1) {
    const rng = mulberry32(seed);
    for (let i = 0; i < size; i++) { u0[i] = 1.0; v0[i] = 0.0; }
    // Seed V in a disk with noise (break symmetry without global clock assumptions).
    const r = Number(elSeedR.value)|0;
    const noise = Number(elSeedNoise.value);
    const cx = (W/2)|0, cy = (H/2)|0;
    for (let y = cy-r; y <= cy+r; y++) {
      for (let x = cx-r; x <= cx+r; x++) {
        const dx = x - cx, dy = y - cy;
        if (dx*dx + dy*dy <= r*r) {
          const i = idx(x,y);
          const nv = (rng()*2 - 1) * noise;
          v0[i] = Math.max(0, Math.min(1, 0.5 + nv));
          u0[i] = 1.0 - v0[i];
        }
      }
    }
    render();
    meta();
  }

  function stepOnce() {
    const Du = Number(elDu.value);
    const Dv = Number(elDv.value);
    const F  = Number(elF.value);
    const k  = Number(elk.value);
    const dt = Number(elDt.value);

    for (let y = 0; y < H; y++) {
      for (let x = 0; x < W; x++) {
        const i = y*W + x;
        const u = u0[i], v = v0[i];

        const lu = lap(u0, x, y);
        const lv = lap(v0, x, y);

        const uvv = u * v * v;
        const du = Du * lu - uvv + F * (1 - u);
        const dv = Dv * lv + uvv - (F + k) * v;

        // Euler integration; clamp to [0,1] since u,v are concentrations.
        const un = u + du * dt;
        const vn = v + dv * dt;

        u1[i] = un < 0 ? 0 : (un > 1 ? 1 : un);
        v1[i] = vn < 0 ? 0 : (vn > 1 ? 1 : vn);
      }
    }

    // swap
    let t = u0; u0 = u1; u1 = t;
    t = v0; v0 = v1; v1 = t;
  }

  function nearestPalette01(s) {
    // Map scalar s in [0,1] to a palette color by nearest in luminance.
    // (Toy mapping; replace with 2D mapping if desired.)
    const target = s;
    let best = 0, bestD = 1e9;
    for (let k = 0; k < PALN.length; k++) {
      const [r,g,b] = PALN[k];
      const lum = 0.2126*r + 0.7152*g + 0.0722*b;
      const d = (lum - target) * (lum - target);
      if (d < bestD) { bestD = d; best = k; }
    }
    return PAL[best];
  }

  function render() {
    const mode = elRenderMode.value;
    for (let i = 0; i < size; i++) {
      const u = u0[i], v = v0[i];
      let s = v;
      if (mode === "u") s = u;
      if (mode === "vu") s = Math.max(0, Math.min(1, 0.5 + (v - u)));
      const [r,g,b] = nearestPalette01(s);

      const o = i*4;
      img.data[o+0] = r;
      img.data[o+1] = g;
      img.data[o+2] = b;
      img.data[o+3] = 255;
    }
    ctx.putImageData(img, 0, 0);
  }

  function meta() {
    const Du = Number(elDu.value).toFixed(3);
    const Dv = Number(elDv.value).toFixed(3);
    const F  = Number(elF.value).toFixed(4);
    const k  = Number(elk.value).toFixed(4);
    const dt = Number(elDt.value).toFixed(2);
    const spf = Number(elSpf.value)|0;
    elMeta.innerHTML = [
      ["grid", `${W}×${H}`],
      ["Du,Dv", `${Du},${Dv}`],
      ["F,k", `${F},${k}`],
      ["dt", `${dt}`],
      ["spf", `${spf}`],
      ["mode", elRenderMode.value],
      ["run", running ? "1" : "0"],
    ].map(([a,b]) => `<span class="pill">${a}: ${b}</span>`).join("");
  }

  function frame() {
    if (running) {
      const spf = Math.max(1, Math.min(50, Number(elSpf.value)|0));
      for (let i = 0; i < spf; i++) stepOnce();
      render();
      meta();
    }
    requestAnimationFrame(frame);
  }

  // Controls
  function rebuild() { alloc(Number(elGrid.value)|0); reset(1); }
  elGrid.addEventListener("change", rebuild);
  elScale.addEventListener("change", () => { alloc(Number(elGrid.value)|0); render(); meta(); });
  [elDu, elDv, elF, elk, elDt, elSpf, elRenderMode].forEach(el => el.addEventListener("change", meta));
  btnReset.addEventListener("click", () => reset(1));
  btnPause.addEventListener("click", () => { running = !running; btnPause.textContent = running ? "Pause" : "Resume"; meta(); });
  btnStep.addEventListener("click", () => { if (!running) { stepOnce(); render(); meta(); } });

  // Initialize
  alloc(Number(elGrid.value)|0);
  reset(1);
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
