<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diffusion Theory Lab</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <style>
    :root { --bg: #05070a; --panel: #0d1117; --border: #21262d; }
    body { background: var(--bg); color: #c9d1d9; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
    canvas { image-rendering: pixelated; border: 1px solid var(--border); background: #000; width: 100%; }
    .stat-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 12px; }
    .label-text { color: #8b949e; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.05em; }
    .math-block { font-size: 0.85rem; color: #58a6ff; margin-top: 4px; }
    .sidebar { width: 320px; border-right: 1px solid var(--border); overflow-y: auto; }
  </style>
</head>
<body class="flex">

  <aside class="sidebar p-6 flex flex-col gap-6 bg-[#0d1117]">
    <div>
      <h1 class="text-xl font-bold text-white mb-2">Latent Lab</h1>
      <p class="text-xs text-gray-500">Stochastic Differential Equation Simulator</p>
    </div>

    <div class="space-y-4">
      <div>
        <span class="label-text">Prompt A (1.0 weight)</span>
        <input id="promptA" type="text" class="w-full bg-black border border-gray-700 p-2 rounded mt-1" value="sky" />
      </div>
      <div>
        <span class="label-text">Prompt B (0.0 weight)</span>
        <input id="promptB" type="text" class="w-full bg-black border border-gray-700 p-2 rounded mt-1" value="lava" />
      </div>
      <div>
        <span class="label-text">Guidance Scale ($\eta$)</span>
        <input id="guidance" type="range" min="0" max="0.5" step="0.01" value="0.15" class="w-full" />
      </div>
      <div>
        <span class="label-text">Total Iterations ($T$)</span>
        <input id="steps" type="number" class="w-full bg-black border border-gray-700 p-2 rounded mt-1" value="100" />
      </div>
    </div>

    <div class="flex flex-col gap-2 pt-4 border-t border-gray-800">
      <button id="runBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">SOLVE SYSTEM</button>
      <button id="resetBtn" class="border border-gray-600 py-2 rounded hover:bg-gray-800">RESET LATENTS</button>
    </div>

    <div class="mt-auto pt-6 border-t border-gray-800 text-[10px] text-gray-600">
      <p>Current Algorithm: Euler-Maruyama Approximation</p>
      <p>Metric: Wasserstein-1 Distance Proxy</p>
    </div>
  </aside>

  <main class="flex-1 p-8 overflow-y-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <div class="stat-card flex flex-col">
        <span class="label-text">Main Reconstruction $x_t$</span>
        <div id="math-xt" class="math-block"></div>
        <canvas id="cv_main" class="mt-4"></canvas>
        <p class="text-[10px] text-gray-500 mt-2">The reverse-diffusion estimate of the clean image $x_0$ at time $t$.</p>
      </div>

      <div class="stat-card flex flex-col">
        <span class="label-text">Cross-Attention Mask $A$</span>
        <div id="math-attn" class="math-block"></div>
        <canvas id="cv_attn" class="mt-4"></canvas>
        <p class="text-[10px] text-gray-500 mt-2">Spatial softmax weights assigning $x,y$ coordinates to specific prompts.</p>
      </div>

      <div class="stat-card flex flex-col">
        <span class="label-text">Conditioning Target $m_c$</span>
        <div id="math-mc" class="math-block"></div>
        <canvas id="cv_target" class="mt-4"></canvas>
        <p class="text-[10px] text-gray-500 mt-2">The ground-truth field generated by the dual-prompt cross-attention.</p>
      </div>

      <div class="stat-card flex flex-col lg:col-span-2">
        <span class="label-text">RGB Signal Density $P(x)$</span>
        <div id="math-px" class="math-block"></div>
        <canvas id="cv_hist" class="h-32 mt-4 border-0"></canvas>
      </div>

      <div class="stat-card flex flex-col">
        <span class="label-text">Kinetic Flux (Work) $\Phi$</span>
        <div id="math-flux" class="math-block"></div>
        <canvas id="cv_flux" class="h-32 mt-4 border-0"></canvas>
      </div>

    </div>
  </main>

<script>
(() => {
  const W = 64, H = 64, N = W * H;
  
  // Visual Dictionary
  const VISUAL_DICTIONARY = {
    sky: (ctx) => { ctx.fillStyle = '#0ea5e9'; ctx.fillRect(0,0,W,H); },
    grass: (ctx) => { ctx.fillStyle = '#166534'; ctx.fillRect(0,H*0.65,W,H*0.35); },
    lava: (ctx) => { ctx.fillStyle = '#ef4444'; ctx.fillRect(0,0,W,H); },
    neon: (ctx) => { ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#22d3ee'; ctx.lineWidth=2; ctx.strokeRect(5,5,W-10,H-10); },
    void: (ctx) => { ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H); }
  };

  let x = new Float32Array(N*3), target = new Float32Array(N*3), attn = new Float32Array(N);
  let fluxHistory = [], running = false, t = 0, T = 100;

  const getCtx = id => { const c = document.getElementById(id); c.width = W; c.height = H; return c.getContext('2d'); };
  const ctxs = {
    main: getCtx('cv_main'), attn: getCtx('cv_attn'), 
    target: getCtx('cv_target'), hist: getCtx('cv_hist'), flux: getCtx('cv_flux')
  };

  // Render LaTeX Equations
  const renderMath = () => {
    const formulas = {
        'math-xt': 'x_{t-1} = x_t + \\eta \\nabla \\log p(x_t) + \\sigma \\epsilon',
        'math-attn': 'A(x,y) = \\text{Softmax}(Q_y K_x^T)',
        'math-mc': 'm_c = A \\cdot P_A + (1-A) \\cdot P_B',
        'math-px': 'P(x) = \\int \\delta(x - x_t) dx',
        'math-flux': '\\Phi = \\sum_{i=1}^N |x_{t,i} - x_{t-1,i}|'
    };
    Object.entries(formulas).forEach(([id, tex]) => {
        katex.render(tex, document.getElementById(id), { throwOnError: false });
    });
  };

  function init() {
    const pA = document.getElementById('promptA').value;
    const pB = document.getElementById('promptB').value;
    T = parseInt(document.getElementById('steps').value);
    
    for(let i=0; i<N; i++) attn[i] = Math.random();

    const offA = document.createElement('canvas'), offB = document.createElement('canvas');
    [offA, offB].forEach(c => { c.width = W; c.height = H; });
    const ctxA = offA.getContext('2d'), ctxB = offB.getContext('2d');
    
    if(VISUAL_DICTIONARY[pA]) VISUAL_DICTIONARY[pA](ctxA);
    if(VISUAL_DICTIONARY[pB]) VISUAL_DICTIONARY[pB](ctxB);

    const dataA = ctxA.getImageData(0,0,W,H).data, dataB = ctxB.getImageData(0,0,W,H).data;
    const targetImg = ctxs.target.createImageData(W,H), attnImg = ctxs.attn.createImageData(W,H);

    for(let i=0; i<N; i++) {
        const mask = attn[i];
        for(let c=0; c<3; c++) {
            const val = (dataA[i*4+c] * mask + dataB[i*4+c] * (1-mask));
            target[i*3+c] = (val / 127.5) - 1;
            targetImg.data[i*4+c] = val;
        }
        targetImg.data[i*4+3] = 255;
        attnImg.data[i*4] = mask * 255;   attnImg.data[i*4+2] = (1-mask)*255; attnImg.data[i*4+3] = 255;
    }
    ctxs.target.putImageData(targetImg, 0, 0);
    ctxs.attn.putImageData(attnImg, 0, 0);

    for(let i=0; i<N*3; i++) x[i] = (Math.random()*2)-1;
    t = T; fluxHistory = []; running = true;
    requestAnimationFrame(loop);
  }

  function step() {
    if(t <= 0) return running = false;
    let work = 0;
    const eta = parseFloat(document.getElementById('guidance').value);

    for(let i=0; i<N*3; i++) {
        const diff = target[i] - x[i];
        const eps = diff * eta;
        const noise = (Math.random()*2-1) * (t/T) * 0.1;
        const prev = x[i];
        x[i] += eps + noise;
        x[i] = Math.max(-1, Math.min(1, x[i]));
        work += Math.abs(x[i] - prev);
    }
    fluxHistory.push(work);
    renderMain(); renderRefinedHistogram(); renderFlux();
    t--;
  }

  function renderMain() {
    const img = ctxs.main.createImageData(W, H);
    for(let i=0; i<N; i++) {
        img.data[i*4] = (x[i*3]+1)*127.5; img.data[i*4+1] = (x[i*3+1]+1)*127.5;
        img.data[i*4+2] = (x[i*3+2]+1)*127.5; img.data[i*4+3] = 255;
    }
    ctxs.main.putImageData(img, 0, 0);
  }

  function renderRefinedHistogram() {
    const h = ctxs.hist, bw = W/20;
    h.clearRect(0,0,W,H);
    const bins = [new Array(20).fill(0), new Array(20).fill(0), new Array(20).fill(0)];
    for(let i=0; i<N; i++) {
        for(let c=0; c<3; c++) {
            const b = Math.floor(((x[i*3+c]+1)/2)*19.9);
            bins[c][b]++;
        }
    }
    const colors = ['#ff4444', '#44ff44', '#4444ff'];
    bins.forEach((chan, c) => {
        h.fillStyle = colors[c]; h.globalAlpha = 0.4;
        chan.forEach((v, i) => h.fillRect(i*bw, H, bw-1, -(v/N)*H*4));
    });
    h.globalAlpha = 1.0;
  }

  function renderFlux() {
    const f = ctxs.flux; f.clearRect(0,0,W,H);
    f.strokeStyle = '#58a6ff'; f.beginPath();
    fluxHistory.forEach((v, i) => {
        const lx = (i/T)*W, ly = H - (v/1500)*H;
        i===0 ? f.moveTo(lx,ly) : f.lineTo(lx,ly);
    });
    f.stroke();
  }

  function loop() { if(running) { step(); requestAnimationFrame(loop); } }
  document.getElementById('runBtn').onclick = init;
  document.getElementById('resetBtn').onclick = () => location.reload();
  renderMath();
})();
</script>
</body>
</html>
