<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SIR Toy Model — Vanilla JS SPA</title><style>:root{--bg:#0b0f14;--panel:#11161d;--muted:#9fb2c6;--text:#dbe7f3;--accent:#4aa3ff;--accent-2:#ff6b6b;--good:#29d398;--warn:#f7b955;--grid:#1a2230}*{box-sizing:border-box}body,html{height:100%}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;overflow:hidden}.wrap{position:relative;height:100%;width:100%;display:grid;grid-template-rows:auto 1fr;gap:8px;padding:12px 12px 84px 12px}header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}.title{font-weight:600;letter-spacing:.2px}.stats{display:grid;grid-auto-flow:column;gap:18px;justify-content:end;align-items:center;color:var(--muted);font-variant-numeric:tabular-nums}.pill{padding:4px 8px;border-radius:999px;background:var(--panel);color:var(--text);border:1px solid #18202c}.pill b{color:var(--accent);font-weight:600}.legend{display:flex;gap:12px;align-items:center;color:var(--muted)}.swatch{width:10px;height:10px;border-radius:2px;display:inline-block;margin-right:6px}.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;height:100%}.card{position:relative;background:var(--panel);border:1px solid #18202c;border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.02)}.card h3{margin:0;padding:10px 12px;font-weight:600;background:#0e141c;border-bottom:1px solid #18202c}.canvas-wrap{position:relative;height:calc(100% - 42px)}canvas{display:block;width:100%;height:100%;background:linear-gradient(#0d131b,#0c1219)}.overlay-note{position:absolute;left:12px;bottom:10px;color:var(--muted);font-size:12px;text-shadow:0 1px 0 #000a}.fab{position:fixed;width:58px;height:58px;border-radius:50%;display:grid;place-items:center;font-size:26px;border:none;cursor:pointer;z-index:30;transition:transform .12s ease,box-shadow .12s ease,background .25s ease;box-shadow:0 10px 24px rgba(0,0,0,.35)}.fab:hover{transform:translateY(-2px);box-shadow:0 14px 30px rgba(0,0,0,.42)}.fab.sim{right:18px;bottom:18px;background:var(--accent);color:#05101c}.fab.doc{left:18px;bottom:18px;background:var(--good);color:#06140f}.fab.critical{animation:critical-pulse 1.8s ease-in-out infinite}@keyframes critical-pulse{0%,100%{box-shadow:0 0 0 0 rgba(247,185,85,0),0 10px 24px rgba(0,0,0,.35)}50%{box-shadow:0 0 0 22px rgba(247,185,85,.12),0 12px 28px rgba(0,0,0,.4)}}.drawer{position:fixed;right:18px;bottom:86px;width:min(420px,calc(100% - 36px));max-height:min(70vh,560px);overflow:auto;padding:12px;background:#0e141c;border:1px solid #192232;border-radius:16px;z-index:20;box-shadow:0 10px 28px rgba(0,0,0,.5);display:none}.drawer.open{display:block}.row{display:grid;grid-template-columns:140px 1fr auto;gap:8px;align-items:center;margin:8px 0}.row label{color:var(--muted)}input[type=range]{width:100%;accent-color:var(--accent)}.val{min-width:64px;text-align:right;color:var(--text);font-variant-numeric:tabular-nums}.btn{appearance:none;border:1px solid #223044;background:#111a26;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}.btn.primary{border-color:#284b7a;background:#0f2136}.btn.danger{border-color:#5a1b1b;background:#221012;color:#ffd0d0}.ctl{display:flex;gap:8px;padding:8px 0 0 0;justify-content:flex-end}.docpanel{position:fixed;left:18px;bottom:86px;width:min(560px,calc(100% - 36px));max-height:min(78vh,680px);overflow:auto;padding:0;background:#0f151f;border:1px solid #1a2636;border-radius:18px;z-index:20;box-shadow:0 10px 28px rgba(0,0,0,.55);display:none}.docpanel.open{display:block}.dochead{position:sticky;top:0;background:#0d141d;border-bottom:1px solid #1a2636;padding:10px 12px}.tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.tab{padding:8px 10px;border-radius:10px;border:1px solid #1f2b3c;background:#0f1a27;color:var(--text);cursor:pointer;font-weight:600}.tab[aria-selected=true]{background:#132237;border-color:#27405f}.docbody{padding:14px 16px;font-size:18px;line-height:1.6}.docbody h4{margin:12px 0 6px 0;font-size:18px}.docbody p{margin:0 0 12px 0;color:#e6eef9}.docbody code{background:#0c1219;border:1px solid #1a2636;padding:1px 6px;border-radius:8px}.docbody ul{margin:6px 0 12px 18px}.docbody li{margin:4px 0}.critical-overlay{pointer-events:none;position:fixed;inset:0;opacity:0;transition:opacity .3s ease;background:radial-gradient(60% 50% at 70% 80%,rgba(247,185,85,.06),rgba(247,185,85,0) 60%),radial-gradient(40% 40% at 20% 20%,rgba(255,107,107,.05),rgba(255,107,107,0) 60%);z-index:10}.critical .critical-overlay{opacity:1}.axis-label{position:absolute;right:10px;top:8px;color:var(--muted);font-size:12px}</style></head><body><div class=wrap id=app><header><div class=title>SIR Toy Model — Agent Field + Time Series</div><div class=stats><span class=pill>S=<b id=sVal>0</b></span> <span class=pill>I=<b id=iVal>0</b></span> <span class=pill>R=<b id=rVal>0</b></span> <span class=pill>R₀≈<b id=r0Val>0.00</b></span> <span class=pill>Rₜ≈<b id=rtVal>0.00</b></span> <span class=legend><span><span class=swatch style=background:#4aa3ff></span>S</span> <span><span class=swatch style=background:#ff6b6b></span>I</span> <span><span class=swatch style=background:#29d398></span>R</span></span></div></header><div class=grid><section class=card id=fieldCard><h3>Agent Field</h3><div class=canvas-wrap><canvas id=field></canvas><div class=overlay-note>2D random walk. Infection on contact within r. Recovery is Poisson with rate γ.</div></div></section><section class=card><h3>Time Series</h3><div class=canvas-wrap><canvas id=chart></canvas><div class=axis-label>time (s)</div></div></section></div></div><button class="fab sim" id=fab title="Simulation Controls">⟲</button> <button class="fab doc" id=docFab title=Documentation>?</button><div class=drawer id=drawer aria-label=Controls><div class=row><label>Population N</label> <input id=N type=range min=50 max=800 step=10 value=240><div class=val id=N_val>240</div></div><div class=row><label>Initial infected i₀</label> <input id=i0 type=range min=0 max=60 step=1 value=6><div class=val id=i0_val>6</div></div><div class=row><label>Speed v (px/s)</label> <input id=speed type=range min=10 max=180 step=5 value=90><div class=val id=speed_val>90</div></div><div class=row><label>Contact radius r (px)</label> <input id=radius type=range min=3 max=16 step=1 value=8><div class=val id=radius_val>8</div></div><div class=row><label>Infectivity p (per contact)</label> <input id=p type=range min=0.02 max=0.9 step=0.01 value=0.22><div class=val id=p_val>0.22</div></div><div class=row><label>Recovery rate γ (1/s)</label> <input id=gamma type=range min=0.001 max=0.2 step=0.001 value=0.02><div class=val id=gamma_val>0.020</div></div><div class=row><label>Noise on p (±%)</label> <input id=noise type=range min=0 max=60 step=2 value=0><div class=val id=noise_val>0%</div></div><div class=row><label>Chart horizon (s)</label> <input id=horizon type=range min=20 max=240 step=10 value=120><div class=val id=horizon_val>120</div></div><div class=ctl><button class=btn id=pauseBtn>Pause</button> <button class="btn primary" id=resetBtn>Reset</button> <button class="btn danger" id=randomBtn>Randomize</button></div></div><div class=docpanel id=docPanel role=dialog aria-label=Documentation><div class=dochead><div class=tabs role=tablist aria-label="Docs tabs"><button class=tab role=tab aria-selected=true aria-controls=tabModel id=tabBtnModel>Model</button> <button class=tab role=tab aria-selected=false aria-controls=tabControls id=tabBtnControls>Controls</button> <button class=tab role=tab aria-selected=false aria-controls=tabThreshold id=tabBtnThreshold>Threshold</button> <button class=tab role=tab aria-selected=false aria-controls=tabNumerics id=tabBtnNumerics>Numerics</button></div></div><div class=docbody><section id=tabModel><h4>Compartment model</h4><p>Agents are <code>S</code>usceptible, <code>I</code>nfected, or <code>R</code>ecovered. Motion is a bounded random walk with specular reflection. A susceptible within radius <code>r</code> of an infected is infected with Bernoulli probability <code>p</code> per contact. Recoveries are a Poisson process with hazard <code>γ</code>.</p></section><section id=tabControls hidden><h4>Controls</h4><ul><li><b>N</b>: live-resized population. Additions spawn as susceptible; removals are unbiased across compartments.</li><li><b>i₀</b>: seeds/removes infected instantly to match the target count.</li><li><b>v,r,p,γ</b>: update dynamics immediately. <b>Noise</b> perturbs <code>p</code> each step.</li><li><b>Horizon</b>: trims the plotted window; does not affect dynamics.</li></ul></section><section id=tabThreshold hidden><h4>Threshold</h4><p>The kinetic approximation yields <code>R₀ ≈ (2 r v ρ p)/γ</code> with areal density <code>ρ=N/A</code>. The effective <code>Rₜ</code> scales as <code>R₀·S/N</code>. When <code>R₀≈1</code> or <code>Rₜ≈1</code>, the UI enters critical mode (pulsing FAB, overlay, velocity quench).</p></section><section id=tabNumerics hidden><h4>Numerics</h4><p>Fixed sub-stepping at <code>h=1/60</code> s with capped <code>Δt≤50</code> ms. Pair checks are O(N²) for clarity; N≤800 is intended. Canvas is pixel-scaled by device pixel ratio.</p></section></div></div><div class=critical-overlay id=critFx></div><script>(()=>{const t=Math.max(1,Math.min(2,window.devicePixelRatio||1)),e=document.getElementById("field"),n=document.getElementById("chart"),o=e.getContext("2d"),a=n.getContext("2d");function i(e){const n=e.parentElement,o=n.clientWidth,a=n.clientHeight;e.width=Math.floor(o*t),e.height=Math.floor(a*t),e.style.width=o+"px",e.style.height=a+"px"}i(e),i(n),addEventListener("resize",()=>{i(e),i(n),N()});const s=t=>document.getElementById(t),l=s("fab"),h=s("drawer");l.onclick=()=>h.classList.toggle("open");const r=s("docFab"),c=s("docPanel");r.onclick=()=>c.classList.toggle("open");const f=[{btn:s("tabBtnModel"),sec:s("tabModel")},{btn:s("tabBtnControls"),sec:s("tabControls")},{btn:s("tabBtnThreshold"),sec:s("tabThreshold")},{btn:s("tabBtnNumerics"),sec:s("tabNumerics")}];for(const t of f)t.btn.addEventListener("click",()=>{for(const e of f)e.btn.setAttribute("aria-selected",e===t?"true":"false"),e.sec.hidden=e!==t});const g=["N","i0","speed","radius","p","gamma","noise","horizon"],d={};for(const t of g){const e=s(t),n=s(t+"_val"),o=e=>"noise"===t?e+"%":"gamma"===t?Number(e).toFixed(3):"p"===t?Number(e).toFixed(2):String(e),a=()=>{d[t]=Number(e.value),n.textContent=o(e.value)};e.addEventListener("input",()=>{a(),k(t)}),a()}let u=[],m=0,b=!1,x={t:[],S:[],I:[],R:[]};const p={width:()=>e.width,height:()=>e.height,rng:v(Date.now()>>>0^2654435769)};function v(t){return function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}function y(t,e){return t+(e-t)*p.rng()}function M(t){return t[t.length*p.rng()|0]}function I({randomize:e=!1}={}){e&&(p.rng=v(Math.random()*2**31^Date.now()>>>0)),u=[],m=0,x={t:[],S:[],I:[],R:[]};const n=p.width()/t,o=p.height()/t;for(let t=0;t<d.N;t++)u.push(S(n,o,"S"));for(let t=0;t<Math.min(d.i0,u.length);t++){const t=M(u);t.state="I",t.tInfected=m}}function S(t,e,n="S"){return{x:y(8,t-8),y:y(8,e-8),vx:y(-1,1),vy:y(-1,1),state:n,tInfected:"I"===n?m:-1}}function k(e){s("i0").max=String(d.N),"N"===e?function(e){const n=p.width()/t,o=p.height()/t,a=e-u.length;if(a>0)for(let t=0;t<a;t++)u.push(S(n,o,"S"));else if(a<0){const t=-a;for(let e=0;e<t&&u.length;e++){const t=u.length*p.rng()|0;u.splice(t,1)}}s("i0").value=String(Math.min(d.i0,u.length)),d.i0=Number(s("i0").value),w(d.i0),N()}(d.N):"i0"===e&&w(d.i0),"N"!==e&&"i0"!==e&&N()}function w(t){const e=[],n=[],o=[];for(let t=0;t<u.length;t++){const a=u[t].state;"I"===a?e.push(t):"S"===a?n.push(t):o.push(t)}const a=e.length;if(t>a){let e=t-a;T(n),T(o);for(let t=0;t<n.length&&e>0;t++,e--){const e=u[n[t]];e.state="I",e.tInfected=m}for(let t=0;t<o.length&&e>0;t++,e--){const e=u[o[t]];e.state="I",e.tInfected=m}}else if(t<a){let n=a-t;T(e);for(let t=0;t<e.length&&n>0;t++,n--){const n=u[e[t]];n.state="S",n.tInfected=-1}}}function T(t){for(let e=t.length-1;e>0;e--){const n=p.rng()*(e+1)|0,o=t[e];t[e]=t[n],t[n]=o}}function C(e){const n=p.width()/t,o=p.height()/t,a=d.speed,i=d.radius,l=i*i,h=d.gamma,r=d.p,c=d.noise/100,f=(g=r*(1+(2*p.rng()-1)*c),Math.max(0,Math.min(1,g)));var g;for(const t of u){const i=Math.atan2(t.vy,t.vx)+.25*(2*p.rng()-1);t.vx=Math.cos(i)*a,t.vy=Math.sin(i)*a,t.x+=t.vx*e,t.y+=t.vy*e,t.x<4&&(t.x=4,t.vx=Math.abs(t.vx)),t.x>n-4&&(t.x=n-4,t.vx=-Math.abs(t.vx)),t.y<4&&(t.y=4,t.vy=Math.abs(t.vy)),t.y>o-4&&(t.y=o-4,t.vy=-Math.abs(t.vy))}const b=[];for(let t=0;t<u.length;t++)"I"===u[t].state&&b.push(t);for(let t=0;t<u.length;t++){const e=u[t];if("S"===e.state)for(let t=0;t<b.length;t++){const n=u[b[t]],o=e.x-n.x,a=e.y-n.y;if(o*o+a*a<=l&&p.rng()<f){e.state="I",e.tInfected=m;break}}}for(const t of u)"I"===t.state&&p.rng()<h*e&&(t.state="R");let v=0,y=0,M=0;for(const t of u)"S"===t.state?v++:"I"===t.state?y++:M++;m+=e,x.t.push(m),x.S.push(v),x.I.push(y),x.R.push(M);const I=Number(d.horizon);for(;x.t.length&&m-x.t[0]>I;)x.t.shift(),x.S.shift(),x.I.shift(),x.R.shift();!function(e,n,o){B.textContent=e,R.textContent=n,F.textContent=o,function(e){const n=p.width()/t*(p.height()/t),o=u.length/Math.max(1,n),a=2*d.radius*d.speed*o*d.p*(e/Math.max(1,u.length))/Math.max(1e-6,d.gamma);s("rtVal").textContent=a.toFixed(2)}(e)}(v,y,M),function(){const t=parseFloat(s("r0Val").textContent),e=parseFloat(s("rtVal").textContent),n=t=>Math.abs(t-1)<.05,o=n(t)||n(e);if(document.body.classList.toggle("critical",o),s("fab").classList.toggle("critical",o),o)for(const t of u)t.vx*=.97,t.vy*=.97}()}function N(){const e=p.width()/t*(p.height()/t),n=u.length/Math.max(1,e),o=2*d.radius*d.speed*n*d.p/Math.max(1e-6,d.gamma);return s("r0Val").textContent=o.toFixed(2),o}function P(e,n,o,a,i,s){if(!(n.length<2)){e.strokeStyle=s,e.lineWidth=2*t,e.beginPath(),e.moveTo(a(n[0]),i(o[0]));for(let t=1;t<n.length;t++)e.lineTo(a(n[t]),i(o[t]));e.stroke()}}const B=s("sVal"),R=s("iVal"),F=s("rVal");s("pauseBtn").onclick=()=>{b=!b,s("pauseBtn").textContent=b?"Resume":"Pause"},s("resetBtn").onclick=()=>{I(),N()},s("randomBtn").onclick=()=>{I({randomize:!0}),N()};let L=performance.now();I(),N(),requestAnimationFrame(function i(s){const l=Math.min(.05,(s-L)/1e3);if(L=s,!b){let i=l;const s=1/60;for(;i>1e-6;){const t=Math.min(s,i);C(t),i-=t}!function(){const n=o,a=e.width,i=e.height;n.save(),n.scale(t,t),n.fillStyle="#0d141d",n.fillRect(0,0,a/t,i/t),n.strokeStyle="#122033",n.lineWidth=1,n.globalAlpha=.6;for(let e=0;e<a/t;e+=32)n.beginPath(),n.moveTo(e,0),n.lineTo(e,i/t),n.stroke();for(let e=0;e<i/t;e+=32)n.beginPath(),n.moveTo(0,e),n.lineTo(a/t,e),n.stroke();n.globalAlpha=1;for(const t of u){const e="S"===t.state?"#4aa3ff":"I"===t.state?"#ff6b6b":"#29d398";n.fillStyle=e,n.beginPath(),n.arc(t.x,t.y,2.2,0,2*Math.PI),n.fill()}const s=u.find(t=>"I"===t.state);s&&(n.strokeStyle="rgba(255,107,107,.15)",n.beginPath(),n.arc(s.x,s.y,d.radius,0,2*Math.PI),n.stroke()),n.restore()}(),function(){const e=a,o=n.width,i=n.height,s=28*t;e.save(),e.fillStyle="#0d131b",e.fillRect(0,0,o,i),e.strokeStyle="#152233",e.lineWidth=1,e.beginPath(),e.moveTo(s,i-s),e.lineTo(o-10,i-s),e.stroke(),e.beginPath(),e.moveTo(s,10),e.lineTo(s,i-s),e.stroke();const l=Math.max(10,...x.S,...x.I,...x.R),h=x.t[0]||0,r=x.t[x.t.length-1]||1,c=t=>s+(o-s-12)*(t-h)/Math.max(1e-6,r-h),f=t=>i-s-(i-s-12)*t/l;e.strokeStyle="#132033",e.lineWidth=1,e.globalAlpha=.6;for(let t=1;t<=4;t++){const n=12+(i-s-12)*t/4;e.beginPath(),e.moveTo(s,n),e.lineTo(o-10,n),e.stroke()}e.globalAlpha=1,P(e,x.t,x.S,c,f,"#4aa3ff"),P(e,x.t,x.I,c,f,"#ff6b6b"),P(e,x.t,x.R,c,f,"#29d398"),e.restore()}()}requestAnimationFrame(i)}),h.classList.add("open"),setTimeout(()=>h.classList.remove("open"),180)})()</script></body></html>