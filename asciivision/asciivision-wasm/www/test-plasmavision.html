<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlasmaVision - Gravitational Glow Test</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            overflow: hidden;
        }
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Vector-style HUD */
        #hud {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 9px;
            letter-spacing: 0.5px;
            color: rgba(0, 255, 100, 0.6);
            pointer-events: none;
            text-transform: uppercase;
        }
        #hud div { margin: 2px 0; }

        /* Tight vector controls */
        #controls {
            position: absolute;
            bottom: 8px;
            left: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: rgba(0, 20, 10, 0.3);
            border: 1px solid rgba(0, 255, 100, 0.15);
            padding: 8px;
        }

        /* Vector slider custom element styling */
        vector-slider {
            --slider-bg: #111;
            --slider-track: rgba(0, 255, 100, 0.2);
            --slider-fill: rgba(0, 255, 100, 0.6);
            --slider-thumb: rgba(0, 255, 100, 0.8);
            --slider-glow: rgba(0, 255, 100, 0.5);
            --text-color: rgba(0, 255, 100, 0.9);
        }

        /* Info panel */
        #info {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 8px;
            color: rgba(0, 180, 80, 0.5);
            text-align: right;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="hud">
        <div>plasmavision</div>
        <div id="fps">--</div>
        <div id="points">--</div>
    </div>

    <div id="controls">
        <vector-slider id="decay" min="0.8" max="0.99" step="0.01" value="0.92" label="phosphor"></vector-slider>
        <vector-slider id="bloom" min="0" max="1" step="0.05" value="0.3" label="bloom"></vector-slider>
        <vector-slider id="scanlines" min="0" max="0.5" step="0.05" value="0.15" label="scanline"></vector-slider>
        <vector-slider id="pointsize" min="1" max="20" step="0.5" value="4" label="glow"></vector-slider>
        <vector-slider id="gravity" min="0" max="3" step="0.1" value="1" label="gravity"></vector-slider>
        <vector-slider id="pulse" min="0" max="2" step="0.1" value="0.5" label="pulse"></vector-slider>
    </div>

    <div id="info">
        drag rotate<br>
        scroll zoom
    </div>

    <script type="module">
        import { PlasmaMass, PlasmaField, PlasmaWireframe, vec3 } from './js/plasmavision/PlasmaGlow.js?v=8';
        import { PlasmaRenderer } from './js/plasmavision/PlasmaRenderer.js?v=8';
        import { VectorSlider } from './js/shared/controls/VectorSlider.js';

        // Setup canvas
        const canvas = document.getElementById('canvas');
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';

        // Create renderer
        const renderer = new PlasmaRenderer(canvas, {
            phosphorDecay: 0.92,
            bloomIntensity: 0.3,
            scanlineIntensity: 0.15,
            pointSize: 4.0
        });

        // Create plasma field with central mass
        const field = new PlasmaField();
        const centralMass = field.addMass(new PlasmaMass({
            position: vec3.create(0, 0, 0),
            mass: 1.0,
            radius: 2.0,
            color: [1, 0.3, 0],  // Orange plasma
            pulse: 0.5
        }));

        // Add orbiting secondary mass
        const orbitMass = field.addMass(new PlasmaMass({
            position: vec3.create(1.5, 0, 0),
            mass: 0.5,
            radius: 1.0,
            color: [0, 0.5, 1],  // Blue plasma
            pulse: 0.8
        }));

        // Create sphere wireframe
        const sphere = PlasmaWireframe.sphere({
            radius: 1.5,
            latSegments: 12,
            lonSegments: 16,
            color: [0, 1, 0.5],
            glow: 1.0,
            glowRadius: 0.15
        });

        // Create cube wireframe
        const cube = PlasmaWireframe.cube({
            size: 0.5,
            color: [1, 1, 0],
            glow: 0.8,
            glowRadius: 0.1
        });

        // Position cube at orbiting mass
        for (const seg of cube.segments) {
            seg.start = vec3.add(seg.start, vec3.create(1.5, 0, 0));
            seg.end = vec3.add(seg.end, vec3.create(1.5, 0, 0));
        }

        // Mouse interaction
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };
        let rotation = { x: 0.4, y: 0.5 };  // Better initial view angle

        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouse = { x: e.clientX, y: e.clientY };
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - lastMouse.x;
            const dy = e.clientY - lastMouse.y;
            rotation.y += dx * 0.01;
            rotation.x += dy * 0.01;
            renderer.setRotation(rotation.x, rotation.y);
            lastMouse = { x: e.clientX, y: e.clientY };
        });

        canvas.addEventListener('mouseup', () => isDragging = false);
        canvas.addEventListener('mouseleave', () => isDragging = false);

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoom = e.deltaY > 0 ? 1.1 : 0.9;
            renderer.camera.position.z *= zoom;
        }, { passive: false });

        // Control sliders - using VectorSlider custom elements
        const sliders = {
            decay: { target: 'phosphorDecay', el: document.getElementById('decay') },
            bloom: { target: 'bloomIntensity', el: document.getElementById('bloom') },
            scanlines: { target: 'scanlineIntensity', el: document.getElementById('scanlines') },
            pointsize: { target: 'pointSize', el: document.getElementById('pointsize') }
        };

        for (const [key, slider] of Object.entries(sliders)) {
            slider.el.addEventListener('input', (e) => {
                renderer.options[slider.target] = e.detail.value;
            });
        }

        // Gravity control
        document.getElementById('gravity').addEventListener('input', (e) => {
            centralMass.mass = e.detail.value;
        });

        // Pulse control
        document.getElementById('pulse').addEventListener('input', (e) => {
            centralMass.pulse = e.detail.value;
            orbitMass.pulse = e.detail.value * 1.6;
        });

        // FPS tracking
        let frameCount = 0;
        let lastFpsTime = performance.now();
        const fpsEl = document.getElementById('fps');
        const pointsEl = document.getElementById('points');

        // Animation loop
        let lastTime = performance.now();
        let orbitAngle = 0;

        function animate() {
            const now = performance.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            // Update orbit
            orbitAngle += dt * 0.5;
            orbitMass.position.x = Math.cos(orbitAngle) * 1.8;
            orbitMass.position.z = Math.sin(orbitAngle) * 1.8;

            // Update cube position to follow orbit mass
            const cubeOffset = vec3.sub(orbitMass.position, vec3.create(1.5, 0, 0));
            // (For simplicity, cube stays at original position - would need to update segment positions)

            // Update plasma field
            field.update(dt);

            // Sample glow points
            const spherePoints = sphere.sampleAllGlow(field, 6, 6);
            const cubePoints = cube.sampleAllGlow(field, 4, 4);
            const allPoints = [...spherePoints, ...cubePoints];

            // Upload wireframe lines (so you can see the sphere shape)
            const allSegments = [...sphere.segments, ...cube.segments];
            renderer.uploadLines(allSegments);

            // Upload glow and render
            renderer.uploadGlowPoints(allPoints);
            renderer.render(dt);

            // FPS
            frameCount++;
            if (now - lastFpsTime >= 1000) {
                fpsEl.textContent = `${frameCount} fps`;
                pointsEl.textContent = `${allPoints.length} pts`;
                frameCount = 0;
                lastFpsTime = now;
            }

            requestAnimationFrame(animate);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            renderer.resize(canvas.width, canvas.height);
        });

        // Start
        renderer.setRotation(rotation.x, rotation.y);
        animate();

        console.log('PlasmaVision initialized');
        console.log('- Sphere wireframe with gravitational glow');
        console.log('- Central orange mass pulls glow inward');
        console.log('- Orbiting blue mass creates asymmetric pull');
    </script>
</body>
</html>
