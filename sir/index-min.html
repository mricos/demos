<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SIR Toy Model — Vanilla JS SPA</title><link rel=stylesheet href=sir.css></head><body><div class=wrap id=app><header><div class=title>SIR Toy Model — Agent Field + Time Series</div><div class=stats><span class=pill><span class=sir-s>S</span>=<b id=sVal>0</b></span> <span class=pill><span class=sir-i>I</span>=<b id=iVal>0</b></span> <span class=pill><span class=sir-r>R</span>=<b id=rVal>0</b></span> <span class=pill><span class=r-number>R₀</span>≈<b id=r0Val>0.00</b></span> <span class=pill><span class=r-number>Rₜ</span>≈<b id=rtVal>0.00</b></span> <span class=legend><span><span class=swatch style=background:#4aa3ff></span><span class=sir-s>S</span></span> <span><span class=swatch style=background:#ff6b6b></span><span class=sir-i>I</span></span> <span><span class=swatch style=background:#29d398></span><span class=sir-r>R</span></span></span></div></header><div class=grid><section class=card id=fieldCard><h3>Agent Field</h3><div class=canvas-wrap><canvas id=field></canvas><div class=overlay-note>2D random walk. Infection on contact within r. Recovery is Poisson with rate γ.</div></div></section><section class=card><h3 style=display:flex;gap:8px;align-items:center><button class="chart-tab active" id=timeSeriesTab>Time Series</button> <button class=chart-tab id=experimentsTab>Experiments</button></h3><div id=timeSeriesView class=canvas-wrap><canvas id=chart></canvas><div class=axis-label>time (s)</div></div><div id=experimentsView style="display:none;height:calc(100% - 42px);overflow-y:auto;padding:12px"><div id=experimentsList style=display:grid;gap:8px></div></div></section></div></div><div class=fab-row><button class="fab doc" id=docFab title=Documentation>?</button> <button class="fab sim" id=fab title="Simulation Controls">⚙</button></div><div class=drawer id=drawer aria-label=Controls><div class=drawer-controls style="border-radius:16px 16px 0 0"><div class="control-section active" id=sirControls><div class=row><label>Population N</label> <input id=N type=range min=50 max=1500 step=10 value=400><div class=val id=N_val>400</div></div><div class=row><label>Initial <span class=sir-i>infected</span> i₀</label> <input id=i0 type=range min=0 max=60 step=1 value=6><div class=val id=i0_val>6</div></div><div class=row><label>Speed v (px/s)</label> <input id=speed type=range min=10 max=180 step=5 value=90><div class=val id=speed_val>90</div></div><div class=row><label>Contact radius r (px)</label> <input id=radius type=range min=3 max=16 step=1 value=8><div class=val id=radius_val>8</div></div><div class=row><label><span class=sir-i>Infectivity</span> p (per contact)</label> <input id=p type=range min=0.02 max=0.9 step=0.01 value=0.22><div class=val id=p_val>0.22</div></div><div class=row><label><span class=sir-r>Recovery</span> rate γ (1/s)</label> <input id=gamma type=range min=0.001 max=0.2 step=0.001 value=0.02><div class=val id=gamma_val>0.020</div></div><div class=row><label>Noise on p (±%)</label> <input id=noise type=range min=0 max=60 step=2 value=0><div class=val id=noise_val>0%</div></div><div class=row><label>Target <span class=r-number>R₀</span></label> <input id=r0Target type=range min=0 max=5.0 step=0.1 value=0><div class=val id=r0Target_val>computed</div></div><div class=row><label>Chart horizon (s)</label> <input id=horizon type=range min=20 max=240 step=10 value=120><div class=val id=horizon_val>120</div></div></div></div><div class=presets-section><div class=preset-tabs><button class=preset-tab id=scenarioTab data-preset-type=scenario>Scenario</button> <button class=preset-tab id=initTab data-preset-type=init>Init</button> <button class=preset-tab id=cliTab data-preset-type=cli>CLI</button></div><div class=preset-content id=scenarioContent><div class=button-grid id=scenarioGrid><button class=grid-btn data-preset=mild>Mild Outbreak</button> <button class=grid-btn data-preset=pandemic>Pandemic</button> <button class=grid-btn data-preset=critical>Critical R₀≈1</button> <button class=grid-btn data-preset=waves>Epidemic Waves</button> <button class=grid-btn data-preset=clusters>Percolation</button> <button class=grid-btn data-preset=dense>Dense Pop</button></div></div><div class=preset-content id=initContent><div class=button-grid id=initGrid><button class="grid-btn selected" data-pattern=random>Random</button> <button class=grid-btn data-pattern=cluster>Cluster</button> <button class=grid-btn data-pattern=line>H-Line</button> <button class=grid-btn data-pattern=vertical>V-Line</button> <button class=grid-btn data-pattern=grid>Grid</button> <button class=grid-btn data-pattern=corners>Corners</button></div></div><div class=preset-content id=cliContent><input id=cliInput placeholder="Type 'help' for commands" style="width:100%;padding:8px;margin-bottom:8px;background:#0a0f16;border:1px solid #223044;border-radius:6px;color:var(--text);font-family:monospace;font-size:13px"><div id=cliOutput style="max-height:140px;overflow-y:auto;background:#0a0f16;border:1px solid #1a2636;border-radius:6px;padding:8px;font-family:monospace;font-size:12px;line-height:1.4;color:var(--muted)"></div></div><div class=drawer-actions><button class="btn primary" id=resetBtn>Reset</button> <button class=btn id=pauseBtn>Pause</button></div></div></div><div id=docPanelContainer></div><div class=critical-overlay id=critFx></div><script>(()=>{const t=Math.max(1,Math.min(2,window.devicePixelRatio||1)),e=document.getElementById("field"),a=document.getElementById("chart"),n=e.getContext("2d"),o=a.getContext("2d");function s(e){const a=e.parentElement,n=a.clientWidth,o=a.clientHeight;e.width=Math.floor(n*t),e.height=Math.floor(o*t),e.style.width=n+"px",e.style.height=o+"px"}s(e),s(a),addEventListener("resize",()=>{s(e),s(a),nt()});const r=t=>document.getElementById(t),i=r("fab"),c=r("drawer");i.onclick=()=>c.classList.toggle("open");let l=null;r("docFab").onclick=()=>{l&&l.classList.toggle("open")},async function(){try{const t=await fetch("sir-docs.html"),e=await t.text();r("docPanelContainer").innerHTML=e,l=r("docPanel"),l&&(l.classList.add("open"),function(){const t=[{btn:r("tabBtnModel"),sec:r("tabModel"),hasSubtabs:!1},{btn:r("tabBtnNumerics"),sec:null,hasSubtabs:!0,subtabsId:"numericsSubtabs"},{btn:r("tabBtnPatterns"),sec:r("tabPatterns"),hasSubtabs:!1},{btn:r("tabBtnExamples"),sec:r("tabExamples"),hasSubtabs:!1},{btn:r("tabBtnConfig"),sec:r("tabConfig"),hasSubtabs:!1}],e=[{btn:r("tabBtnNumThreshold"),sec:r("tabNumThreshold")},{btn:r("tabBtnNumR0Control"),sec:r("tabNumR0Control")}],a=r("numericsSubtabs"),n=[...t.filter(t=>t.sec).map(t=>t.sec),...e.map(t=>t.sec)];for(const o of t)o.btn.addEventListener("click",()=>{for(const e of t)e.btn.setAttribute("aria-selected",e===o?"true":"false");a.classList.remove("active"),o.hasSubtabs?(a.classList.add("active"),n.forEach(t=>t.hidden=!0),e[0].sec.hidden=!1,e.forEach((t,e)=>t.btn.setAttribute("aria-selected",0===e?"true":"false"))):(n.forEach(t=>t.hidden=!0),o.sec&&(o.sec.hidden=!1))});for(const t of e)t.btn.addEventListener("click",()=>{for(const a of e)a.btn.setAttribute("aria-selected",a===t?"true":"false");n.forEach(t=>t.hidden=!0),t.sec.hidden=!1});const o=r("drawerOpacity"),s=r("drawerOpacity_val");o&&o.addEventListener("input",()=>{const t=Number(o.value);s.textContent=Math.round(100*t)+"%",c.style.opacity=t});const i=r("saveConfigBtn"),l=r("loadConfigBtn");i&&i.addEventListener("click",function(){const t=getComputedStyle(document.documentElement),e={drawerOpacity:Number(o.value),tokens:{bg:t.getPropertyValue("--bg").trim(),panel:t.getPropertyValue("--panel").trim(),muted:t.getPropertyValue("--muted").trim(),text:t.getPropertyValue("--text").trim(),accent:t.getPropertyValue("--accent").trim(),selectedBorder:t.getPropertyValue("--selected-border").trim(),selectedBg:t.getPropertyValue("--selected-bg").trim()},timestamp:(new Date).toISOString()};localStorage.setItem("sir_ui_config",JSON.stringify(e)),alert("Configuration saved!")}),l&&l.addEventListener("click",function(){try{const t=localStorage.getItem("sir_ui_config");if(!t)return void alert("No saved configuration found");const e=JSON.parse(t),a=document.documentElement;e.tokens&&(a.style.setProperty("--bg",e.tokens.bg),a.style.setProperty("--panel",e.tokens.panel),a.style.setProperty("--muted",e.tokens.muted),a.style.setProperty("--text",e.tokens.text),a.style.setProperty("--accent",e.tokens.accent),a.style.setProperty("--selected-border",e.tokens.selectedBorder),a.style.setProperty("--selected-bg",e.tokens.selectedBg)),e.drawerOpacity&&(o.value=e.drawerOpacity,s.textContent=Math.round(100*e.drawerOpacity)+"%",c.style.opacity=e.drawerOpacity),alert("Configuration loaded!")}catch(t){alert("Failed to load configuration: "+t.message)}}),document.querySelectorAll(".param-set").forEach(t=>{t.addEventListener("click",()=>{!function(t,e){const a=r(t);if(!a)return;a.value=e;const n=r(t+"_val");var o;V[t]=Number(a.value),n.textContent=(o=a.value,"noise"===t?o+"%":"gamma"===t?Number(o).toFixed(3):"p"===t?Number(o).toFixed(2):String(o)),Z(t)}(t.dataset.param,t.dataset.value),t.style.background="rgba(74,163,255,.35)",setTimeout(()=>{t.style.background=""},200)})}),document.querySelectorAll(".example-btn").forEach(t=>{t.addEventListener("click",()=>{q(t.dataset.example)})})}())}catch(t){console.error("Failed to load docs:",t)}}();let d="random",u="sir";const m={sir:{scenarios:{mild:{N:400,i0:8,speed:90,radius:8,p:.1,gamma:.02,noise:0,horizon:120,pattern:"random"},pandemic:{N:800,i0:20,speed:120,radius:10,p:.35,gamma:.015,noise:0,horizon:180,pattern:"cluster"},critical:{N:600,i0:10,speed:60,radius:6,p:.15,gamma:.025,noise:0,horizon:120,pattern:"random"},waves:{N:1e3,i0:5,speed:100,radius:9,p:.28,gamma:.018,noise:0,horizon:200,pattern:"line"},clusters:{N:500,i0:8,speed:70,radius:7,p:.18,gamma:.022,noise:0,horizon:150,pattern:"corners"},dense:{N:1200,i0:15,speed:80,radius:8,p:.25,gamma:.02,noise:0,horizon:180,pattern:"grid"}},scenarioLabels:{mild:"Mild Outbreak",pandemic:"Pandemic",critical:"Critical R₀≈1",waves:"Epidemic Waves",clusters:"Percolation",dense:"Dense Pop"},initPatterns:{random:"Random",cluster:"Cluster",line:"H-Line",vertical:"V-Line",grid:"Grid",corners:"Corners"}}};function f(){document.querySelectorAll("#scenarioGrid .grid-btn").forEach(t=>{t.onclick=()=>{const e=t.dataset.preset,a=m[u].scenarios[e];if(a){for(const t of z)if(t in a){const e=r(t),n=r(t+"_val");e.value=a[t];const o=e=>"noise"===t?e+"%":"gamma"===t?Number(e).toFixed(3):"p"===t?Number(e).toFixed(2):String(e);V[t]=Number(e.value),n.textContent=o(e.value)}d=a.pattern||"random",X(),nt(),document.querySelectorAll("#scenarioGrid .grid-btn").forEach(t=>t.classList.remove("selected")),t.classList.add("selected")}}}),document.querySelectorAll("#initGrid .grid-btn").forEach(t=>{t.onclick=()=>{const e=t.dataset.pattern;document.querySelectorAll("#initGrid .grid-btn").forEach(t=>t.classList.remove("selected")),t.classList.add("selected"),d=e,X(),nt()}})}document.querySelectorAll(".control-tab").forEach(t=>{t.addEventListener("click",()=>{t.disabled||function(t){if(u===t)return;u=t,document.querySelectorAll(".control-tab").forEach(e=>{e.classList.toggle("active",e.dataset.control===t)}),document.querySelectorAll(".control-section").forEach(t=>{t.classList.remove("active")});const e=document.getElementById(t+"Controls");e&&e.classList.add("active"),function(t){const e=m[t];if(!e)return;const a=r("scenarioGrid");a.innerHTML="";for(const[t,n]of Object.entries(e.scenarioLabels)){const e=document.createElement("button");e.className="grid-btn",e.dataset.preset=t,e.textContent=n,a.appendChild(e)}const n=r("initGrid");n.innerHTML="";let o=!0;for(const[t,a]of Object.entries(e.initPatterns)){const e=document.createElement("button");e.className="grid-btn",o&&(e.classList.add("selected"),d=t,o=!1),e.dataset.pattern=t,e.textContent=a,n.appendChild(e)}f()}(t),X(),nt()}(t.dataset.control)})});let p="computed";const h=r("r0Target"),b=r("r0Target_val");h.addEventListener("input",()=>{const t=Number(h.value);0===t?(p="computed",b.textContent="computed",nt()):(p="manual",b.textContent=t.toFixed(1),B(t))});const g=r("scenarioTab"),v=r("initTab"),x=r("cliTab"),y=r("scenarioContent"),S=r("initContent"),k=r("cliContent");let I=null;function L(t,e){I===t?(t.classList.remove("active"),e.classList.remove("open"),I=null):(g.classList.remove("active"),v.classList.remove("active"),x.classList.remove("active"),y.classList.remove("open"),S.classList.remove("open"),k.classList.remove("open"),t.classList.add("active"),e.classList.add("open"),I=t,t===x&&setTimeout(()=>r("cliInput").focus(),100))}g.onclick=()=>L(g,y),v.onclick=()=>L(v,S),x.onclick=()=>L(x,k);const N=r("cliInput"),M=r("cliOutput");function E(t,e="#9fb2c6"){const a=document.createElement("div");a.style.color=e,a.textContent=t,M.appendChild(a),M.scrollTop=M.scrollHeight}function C(){const t=parseFloat(r("r0Val").textContent),e=G;let a=0,n=0;for(let t=0;t<e.I.length;t++)e.I[t]>a&&(a=e.I[t],n=e.t[t]);const o=e.R[e.R.length-1]||0,s=o/V.N,i=.95*V.N;let c=e.t[e.t.length-1];for(let t=0;t<e.R.length;t++)if(e.R[t]>=i){c=e.t[t];break}let l=0;for(let t=1;t<e.I.length;t++)l+=(e.I[t]+e.I[t-1])*(e.t[t]-e.t[t-1])/2;return{R0:t,t_peak:n,I_max:a,R_final:o,attack_rate:s,duration:c,auc_I:l}}function w(t){if(!t)return void E("Usage: load [name]","#ff6b6b");const e=JSON.parse(localStorage.getItem("sir_presets")||"{}");if(!e[t])return void E(`Preset '${t}' not found`,"#ff6b6b");const a=e[t];for(const t of z)if(t in a.params){const e=r(t),n=r(t+"_val");e.value=a.params[t],V[t]=a.params[t];const o=e=>"noise"===t?e+"%":"gamma"===t?Number(e).toFixed(3):"p"===t?Number(e).toFixed(2):String(e);n.textContent=o(e.value)}a.pattern&&(d=a.pattern),X(),nt(),E(`Loaded '${t}'`,"#29d398")}function _(t){("chart"===t?a:e).toBlob(e=>{const a=URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=`sir_${t}_${Date.now()}.png`,n.click(),URL.revokeObjectURL(a),E(`Exported ${t} as PNG`,"#29d398")})}N.addEventListener("keydown",t=>{if("Enter"===t.key){const t=N.value;N.value="",function(t){const e=t.trim().split(/\s+/),a=e[0],n=e.slice(1);if(E(`> ${t}`,"#4aa3ff"),a)switch(a){case"help":E("Available commands:","#4aa3ff"),E("  help              Show this help","#9fb2c6"),E("  save [name]       Save current params + curve summary","#9fb2c6"),E("  load [name]       Load saved preset","#9fb2c6"),E("  rm [name]         Remove saved preset","#9fb2c6"),E("  ls                List saved presets","#9fb2c6"),E("  export field      Export field canvas as PNG","#9fb2c6"),E("  export chart      Export chart canvas as PNG","#9fb2c6"),E("  export data       Export simulation data as JSON","#9fb2c6"),E("  curves            Show current curve parameters","#9fb2c6"),E("  clear             Clear output","#9fb2c6");break;case"save":!function(t){if(!t)return void E("Usage: save [name]","#ff6b6b");const e=C(),a={params:{...V},curves:e,pattern:d,timestamp:(new Date).toISOString()},n=JSON.parse(localStorage.getItem("sir_presets")||"{}");n[t]=a,localStorage.setItem("sir_presets",JSON.stringify(n)),E(`Saved '${t}': R₀=${e.R0.toFixed(2)}, τ=${e.t_peak.toFixed(1)}s, α=${(100*e.attack_rate).toFixed(1)}%`,"#29d398"),"none"!==T.style.display&&A()}(n[0]);break;case"load":w(n[0]);break;case"rm":!function(t){if(!t)return void E("Usage: rm [name]","#ff6b6b");const e=JSON.parse(localStorage.getItem("sir_presets")||"{}");e[t]?(delete e[t],localStorage.setItem("sir_presets",JSON.stringify(e)),E(`Removed '${t}'`,"#f7b955"),"none"!==T.style.display&&A()):E(`Preset '${t}' not found`,"#ff6b6b")}(n[0]);break;case"ls":!function(){const t=JSON.parse(localStorage.getItem("sir_presets")||"{}"),e=Object.keys(t);0!==e.length?(E(`Saved presets (${e.length}):`,"#4aa3ff"),e.forEach(e=>{const a=t[e].curves;E(`  ${e}: R₀=${a.R0.toFixed(2)}, τ=${a.t_peak.toFixed(1)}s, α=${(100*a.attack_rate).toFixed(1)}%`,"#9fb2c6")})):E("No saved presets","#9fb2c6")}();break;case"export":"field"===n[0]?_("field"):"chart"===n[0]?_("chart"):"data"===n[0]?function(){const t={params:V,curves:C(),series:G,timestamp:(new Date).toISOString()},e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),a=URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=`sir_data_${Date.now()}.json`,n.click(),URL.revokeObjectURL(a),E("Exported data as JSON","#29d398")}():E("Usage: export [field|chart|data]","#ff6b6b");break;case"curves":!function(){const t=C();E("Current curve parameters:","#4aa3ff"),E(`  R₀ = ${t.R0.toFixed(2)} (basic reproduction number)`,"#9fb2c6"),E(`  τ  = ${t.t_peak.toFixed(1)}s (time to peak infection)`,"#9fb2c6"),E(`  α  = ${(100*t.attack_rate).toFixed(1)}% (attack rate)`,"#9fb2c6"),E(`  I_max = ${t.I_max} (peak infections)`,"#9fb2c6"),E(`  Duration = ${t.duration.toFixed(1)}s (to 95% recovered)`,"#9fb2c6"),E(`  AUC(I) = ${t.auc_I.toFixed(0)} (total infection-days)`,"#9fb2c6")}();break;case"clear":M.innerHTML="";break;default:E(`Unknown command: ${a}. Type 'help' for commands.`,"#ff6b6b")}}(t)}});const F=r("timeSeriesTab"),P=r("experimentsTab"),R=r("timeSeriesView"),T=r("experimentsView"),$=r("experimentsList");function O(t){"timeseries"===t?(F.classList.add("active"),P.classList.remove("active"),R.style.display="block",T.style.display="none"):(F.classList.remove("active"),P.classList.add("active"),R.style.display="none",T.style.display="block",A())}function A(){const t=JSON.parse(localStorage.getItem("sir_presets")||"{}"),e=Object.keys(t).sort();0!==e.length?($.innerHTML="",e.forEach(e=>{const a=t[e],n=a.curves,o=new Date(a.timestamp).toLocaleString(),s=document.createElement("div");s.className="experiment-item";const r=document.createElement("canvas");r.width=50,r.height=50;const i=document.createElement("div");i.style.flex="1",i.innerHTML=`\n        <div class="exp-name">${e}</div>\n        <div class="exp-params">R₀=${n.R0.toFixed(2)}, τ=${n.t_peak.toFixed(1)}s, α=${(100*n.attack_rate).toFixed(1)}%</div>\n        <div class="exp-params">I_max=${n.I_max}, Duration=${n.duration.toFixed(1)}s, AUC=${n.auc_I.toFixed(0)}</div>\n        <div class="exp-timestamp">${o}</div>\n      `,s.appendChild(r),s.appendChild(i),s.onclick=()=>{w(e),O("timeseries")},$.appendChild(s),function(t,e,a){const n=t.getContext("2d"),o=t.width,s=t.height;n.fillStyle="#0a0f16",n.fillRect(0,0,o,s);const r=a.N,i=1.2*e.duration,c=e.t_peak,l=e.I_max,d=e.R_final,u=[],m=[],f=[];for(let t=0;t<60;t++){const a=t/59*i,n=c/2.5,o=l*Math.exp(-Math.pow(a-c,2)/(2*n*n));m.push(o);const s=4/e.duration,p=d/(1+Math.exp(-s*(a-e.duration/2)));f.push(p);const h=r-o-p;u.push(Math.max(0,h))}const p=Math.max(...u,...m,...f,r),h=t=>t/59*o,b=t=>s-t/p*s,g=(t,e,a=1.5)=>{n.strokeStyle=e,n.lineWidth=a,n.beginPath(),n.moveTo(h(0),b(t[0]));for(let e=1;e<t.length;e++)n.lineTo(h(e),b(t[e]));n.stroke()};g(u,"#4aa3ff"),g(m,"#ff6b6b"),g(f,"#29d398")}(r,n,a.params)})):$.innerHTML='<div style="text-align:center; color:var(--muted); padding:20px;">No experiments saved yet.<br><br>Use the CLI to save experiments:<br><code style="background:#0a0f16; padding:4px 8px; border-radius:4px;">save [name]</code></div>'}function B(a){const n=e.width/t*(e.height/t),o=J.length/Math.max(1,n),s=2*V.radius*V.speed*o,i=a*V.gamma/Math.max(1e-6,s),c=Math.max(.02,Math.min(.9,i)),l=r("p"),d=r("p_val");l.value=c,V.p=c,d.textContent=c.toFixed(2),nt()}F.onclick=()=>O("timeseries"),P.onclick=()=>O("experiments"),f(),h.addEventListener("input",()=>{const t=Number(h.value);b.textContent=t.toFixed(1),"manual"===p&&B(t)});const z=["N","i0","speed","radius","p","gamma","noise","horizon"],V={};for(const t of z){const e=r(t),a=r(t+"_val"),n=e=>"noise"===t?e+"%":"gamma"===t?Number(e).toFixed(3):"p"===t?Number(e).toFixed(2):String(e),o=()=>{V[t]=Number(e.value),a.textContent=n(e.value)};e.addEventListener("input",()=>{o(),Z(t)}),o()}const U={mild:{N:400,i0:8,speed:90,radius:8,p:.1,gamma:.02,noise:0,horizon:120},fastspread:{N:600,i0:12,speed:150,radius:10,p:.4,gamma:.02,noise:0,horizon:120},critical:{N:600,i0:10,speed:60,radius:6,p:.15,gamma:.025,noise:0,horizon:120},superspreader:{N:800,i0:40,speed:100,radius:9,p:.25,gamma:.02,noise:0,horizon:120},slowburn:{N:500,i0:10,speed:30,radius:8,p:.22,gamma:.005,noise:0,horizon:180},fastrecovery:{N:500,i0:10,speed:90,radius:8,p:.3,gamma:.08,noise:0,horizon:120}};function q(t){const e=U[t];if(e)for(const t of z)if(t in e){const a=r(t),n=r(t+"_val");a.value=e[t];const o=e=>"noise"===t?e+"%":"gamma"===t?Number(e).toFixed(3):"p"===t?Number(e).toFixed(2):String(e);V[t]=Number(a.value),n.textContent=o(a.value),Z(t)}}document.querySelectorAll(".example-btn").forEach(t=>{t.addEventListener("click",()=>{q(t.dataset.example)})}),document.querySelectorAll(".param-set").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.param,a=t.dataset.value,n=r(e);if(!n)return;n.value=a;const o=r(e+"_val");var s;V[e]=Number(n.value),o.textContent=(s=n.value,"noise"===e?s+"%":"gamma"===e?Number(s).toFixed(3):"p"===e?Number(s).toFixed(2):String(s)),Z(e),t.style.background="rgba(74,163,255,.35)",setTimeout(()=>{t.style.background=""},200)})});let J=[],D=0,j=!1,G={t:[],S:[],I:[],R:[]};const H={width:()=>e.width,height:()=>e.height,rng:W(Date.now()>>>0^2654435769)};function W(t){return function(){let e=t+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296}}function K(t,e){return t+(e-t)*H.rng()}function Q(t){return t[t.length*H.rng()|0]}function X({randomize:e=!1}={}){e&&(H.rng=W(Math.random()*2**31^Date.now()>>>0)),J=[],D=0,G={t:[],S:[],I:[],R:[]};const a=H.width()/t,n=H.height()/t;for(let t=0;t<V.N;t++)J.push(Y(a,n,"S"));!function(t,e){const a=Math.min(V.i0,J.length);if("random"===d)for(let t=0;t<a;t++){const t=Q(J);t.state="I",t.tInfected=D}else if("cluster"===d){const n=t/2,o=e/2,s=J.slice().sort((t,e)=>(t.x-n)**2+(t.y-o)**2-((e.x-n)**2+(e.y-o)**2));for(let t=0;t<a;t++)s[t].state="I",s[t].tInfected=D}else if("line"===d){const t=J.slice().sort((t,a)=>Math.abs(t.y-e/2)-Math.abs(a.y-e/2));for(let e=0;e<a;e++)t[e].state="I",t[e].tInfected=D}else if("vertical"===d){const e=J.slice().sort((e,a)=>Math.abs(e.x-t/2)-Math.abs(a.x-t/2));for(let t=0;t<a;t++)e[t].state="I",e[t].tInfected=D}else if("grid"===d){const n=Math.ceil(Math.sqrt(a));let o=0;for(let s=0;s<n&&o<a;s++)for(let r=0;r<n&&o<a;r++){const a=(r+1)/(n+1)*t,i=(s+1)/(n+1)*e,c=J.filter(t=>"S"===t.state).sort((t,e)=>(t.x-a)**2+(t.y-i)**2-((e.x-a)**2+(e.y-i)**2));c[0]&&(c[0].state="I",c[0].tInfected=D,o++)}}else if("corners"===d){const n=[[.25*t,.25*e],[.75*t,.25*e],[.25*t,.75*e],[.75*t,.75*e]];let o=0;for(let t of n){const e=Math.floor(a/4)+(o<a%4?1:0),n=J.filter(t=>"S"===t.state).sort((e,a)=>(e.x-t[0])**2+(e.y-t[1])**2-((a.x-t[0])**2+(a.y-t[1])**2));for(let t=0;t<e&&o<a;t++)n[t]&&(n[t].state="I",n[t].tInfected=D,o++)}}}(a,n)}function Y(t,e,a="S"){return{x:K(8,t-8),y:K(8,e-8),vx:K(-1,1),vy:K(-1,1),state:a,tInfected:"I"===a?D:-1}}function Z(e){r("i0").max=String(V.N),"N"===e?function(e){const a=H.width()/t,n=H.height()/t,o=e-J.length;if(o>0)for(let t=0;t<o;t++)J.push(Y(a,n,"S"));else if(o<0){const t=-o;for(let e=0;e<t&&J.length;e++){const t=J.length*H.rng()|0;J.splice(t,1)}}r("i0").value=String(Math.min(V.i0,J.length)),V.i0=Number(r("i0").value),tt(V.i0),nt()}(V.N):"i0"===e&&tt(V.i0),"manual"===p&&"p"!==e&&"i0"!==e&&"horizon"!==e?B(Number(h.value)):"N"!==e&&"i0"!==e&&nt()}function tt(t){const e=[],a=[],n=[];for(let t=0;t<J.length;t++){const o=J[t].state;"I"===o?e.push(t):"S"===o?a.push(t):n.push(t)}const o=e.length;if(t>o){let e=t-o;et(a),et(n);for(let t=0;t<a.length&&e>0;t++,e--){const e=J[a[t]];e.state="I",e.tInfected=D}for(let t=0;t<n.length&&e>0;t++,e--){const e=J[n[t]];e.state="I",e.tInfected=D}}else if(t<o){let a=o-t;et(e);for(let t=0;t<e.length&&a>0;t++,a--){const a=J[e[t]];a.state="S",a.tInfected=-1}}}function et(t){for(let e=t.length-1;e>0;e--){const a=H.rng()*(e+1)|0,n=t[e];t[e]=t[a],t[a]=n}}function at(e){const a=H.width()/t,n=H.height()/t,o=V.speed,s=V.radius,i=s*s,c=V.gamma,l=V.p,d=V.noise/100,u=(m=l*(1+(2*H.rng()-1)*d),Math.max(0,Math.min(1,m)));var m;for(const t of J){const s=Math.atan2(t.vy,t.vx)+.25*(2*H.rng()-1);t.vx=Math.cos(s)*o,t.vy=Math.sin(s)*o,t.x+=t.vx*e,t.y+=t.vy*e,t.x<4&&(t.x=4,t.vx=Math.abs(t.vx)),t.x>a-4&&(t.x=a-4,t.vx=-Math.abs(t.vx)),t.y<4&&(t.y=4,t.vy=Math.abs(t.vy)),t.y>n-4&&(t.y=n-4,t.vy=-Math.abs(t.vy))}const f=[];for(let t=0;t<J.length;t++)"I"===J[t].state&&f.push(t);for(let t=0;t<J.length;t++){const e=J[t];if("S"===e.state)for(let t=0;t<f.length;t++){const a=J[f[t]],n=e.x-a.x,o=e.y-a.y;if(n*n+o*o<=i&&H.rng()<u){e.state="I",e.tInfected=D;break}}}for(const t of J)"I"===t.state&&H.rng()<c*e&&(t.state="R");let p=0,h=0,b=0;for(const t of J)"S"===t.state?p++:"I"===t.state?h++:b++;D+=e,G.t.push(D),G.S.push(p),G.I.push(h),G.R.push(b);const g=Number(V.horizon);for(;G.t.length&&D-G.t[0]>g;)G.t.shift(),G.S.shift(),G.I.shift(),G.R.shift();!function(e,a,n){st.textContent=e,rt.textContent=a,it.textContent=n,function(e){const a=H.width()/t*(H.height()/t),n=J.length/Math.max(1,a),o=2*V.radius*V.speed*n*V.p*(e/Math.max(1,J.length))/Math.max(1e-6,V.gamma);r("rtVal").textContent=o.toFixed(2)}(e)}(p,h,b),function(){const t=parseFloat(r("r0Val").textContent),e=parseFloat(r("rtVal").textContent),a=t=>Math.abs(t-1)<.05,n=a(t)||a(e);if(document.body.classList.toggle("critical",n),r("fab").classList.toggle("critical",n),n)for(const t of J)t.vx*=.97,t.vy*=.97}()}function nt(){const e=H.width()/t*(H.height()/t),a=J.length/Math.max(1,e),n=2*V.radius*V.speed*a*V.p/Math.max(1e-6,V.gamma);return r("r0Val").textContent=n.toFixed(2),n}function ot(e,a,n,o,s,r){if(!(a.length<2)){e.strokeStyle=r,e.lineWidth=2*t,e.beginPath(),e.moveTo(o(a[0]),s(n[0]));for(let t=1;t<a.length;t++)e.lineTo(o(a[t]),s(n[t]));e.stroke()}}const st=r("sVal"),rt=r("iVal"),it=r("rVal");r("pauseBtn").onclick=()=>{j=!j,r("pauseBtn").textContent=j?"Resume":"Pause"},r("resetBtn").onclick=()=>{X({randomize:!0}),nt()};let ct=performance.now();X(),nt(),requestAnimationFrame(function s(r){const i=Math.min(.05,(r-ct)/1e3);if(ct=r,!j){let s=i;const r=1/60;for(;s>1e-6;){const t=Math.min(r,s);at(t),s-=t}!function(){const a=n,o=e.width,s=e.height;a.save(),a.scale(t,t),a.fillStyle="#0d141d",a.fillRect(0,0,o/t,s/t),a.strokeStyle="#122033",a.lineWidth=1,a.globalAlpha=.6;for(let e=0;e<o/t;e+=32)a.beginPath(),a.moveTo(e,0),a.lineTo(e,s/t),a.stroke();for(let e=0;e<s/t;e+=32)a.beginPath(),a.moveTo(0,e),a.lineTo(o/t,e),a.stroke();a.globalAlpha=1;for(const t of J){const e="S"===t.state?"#4aa3ff":"I"===t.state?"#ff6b6b":"#29d398";a.fillStyle=e,a.beginPath(),a.arc(t.x,t.y,2.2,0,2*Math.PI),a.fill()}const r=J.find(t=>"I"===t.state);r&&(a.strokeStyle="rgba(255,107,107,.15)",a.beginPath(),a.arc(r.x,r.y,V.radius,0,2*Math.PI),a.stroke()),a.restore()}(),function(){const e=o,n=a.width,s=a.height,r=28*t;e.save(),e.fillStyle="#0d131b",e.fillRect(0,0,n,s),e.strokeStyle="#152233",e.lineWidth=1,e.beginPath(),e.moveTo(r,s-r),e.lineTo(n-10,s-r),e.stroke(),e.beginPath(),e.moveTo(r,10),e.lineTo(r,s-r),e.stroke();const i=Math.max(10,...G.S,...G.I,...G.R),c=G.t[0]||0,l=G.t[G.t.length-1]||1,d=t=>r+(n-r-12)*(t-c)/Math.max(1e-6,l-c),u=t=>s-r-(s-r-12)*t/i;e.strokeStyle="#132033",e.lineWidth=1,e.globalAlpha=.6;for(let t=1;t<=4;t++){const a=12+(s-r-12)*t/4;e.beginPath(),e.moveTo(r,a),e.lineTo(n-10,a),e.stroke()}e.globalAlpha=1,ot(e,G.t,G.S,d,u,"#4aa3ff"),ot(e,G.t,G.I,d,u,"#ff6b6b"),ot(e,G.t,G.R,d,u,"#29d398"),e.restore()}()}requestAnimationFrame(s)}),c.classList.add("open"),setTimeout(()=>c.classList.remove("open"),180)})()</script></body></html>