<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlasmaVision - Gravitational Glow Test</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 12px;
            color: #0a0;
            pointer-events: none;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 11px;
            color: #080;
        }
        #controls .row {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #controls label {
            min-width: 120px;
        }
        #controls input[type="range"] {
            width: 150px;
            accent-color: #0f0;
        }
        #controls .value {
            color: #0f0;
            min-width: 50px;
        }
        #info {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 11px;
            color: #0a0;
            text-align: right;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="hud">
        <div>PLASMAVISION - Gravitational Glow</div>
        <div id="fps">FPS: --</div>
        <div id="points">Points: --</div>
    </div>

    <div id="controls">
        <div class="row">
            <label>Phosphor Decay:</label>
            <input type="range" id="decay" min="0.8" max="0.99" step="0.01" value="0.92">
            <span class="value" id="decay-val">0.92</span>
        </div>
        <div class="row">
            <label>Bloom Intensity:</label>
            <input type="range" id="bloom" min="0" max="1" step="0.05" value="0.3">
            <span class="value" id="bloom-val">0.30</span>
        </div>
        <div class="row">
            <label>Scanlines:</label>
            <input type="range" id="scanlines" min="0" max="0.5" step="0.05" value="0.15">
            <span class="value" id="scanlines-val">0.15</span>
        </div>
        <div class="row">
            <label>Point Size:</label>
            <input type="range" id="pointsize" min="1" max="20" step="0.5" value="4">
            <span class="value" id="pointsize-val">4.0</span>
        </div>
        <div class="row">
            <label>Gravity Strength:</label>
            <input type="range" id="gravity" min="0" max="3" step="0.1" value="1">
            <span class="value" id="gravity-val">1.0</span>
        </div>
        <div class="row">
            <label>Mass Pulse:</label>
            <input type="range" id="pulse" min="0" max="2" step="0.1" value="0.5">
            <span class="value" id="pulse-val">0.5</span>
        </div>
    </div>

    <div id="info">
        Drag to rotate<br>
        Scroll to zoom<br>
        <br>
        Sphere wireframe with<br>
        plasma mass at center<br>
        pulling the glow inward
    </div>

    <script type="module">
        import { PlasmaMass, PlasmaField, PlasmaWireframe, vec3 } from './js/plasmavision/PlasmaGlow.js?v=7';
        import { PlasmaRenderer } from './js/plasmavision/PlasmaRenderer.js?v=7';

        // Setup canvas
        const canvas = document.getElementById('canvas');
        canvas.width = window.innerWidth * window.devicePixelRatio;
        canvas.height = window.innerHeight * window.devicePixelRatio;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';

        // Create renderer
        const renderer = new PlasmaRenderer(canvas, {
            phosphorDecay: 0.92,
            bloomIntensity: 0.3,
            scanlineIntensity: 0.15,
            pointSize: 4.0
        });

        // Create plasma field with central mass
        const field = new PlasmaField();
        const centralMass = field.addMass(new PlasmaMass({
            position: vec3.create(0, 0, 0),
            mass: 1.0,
            radius: 2.0,
            color: [1, 0.3, 0],  // Orange plasma
            pulse: 0.5
        }));

        // Add orbiting secondary mass
        const orbitMass = field.addMass(new PlasmaMass({
            position: vec3.create(1.5, 0, 0),
            mass: 0.5,
            radius: 1.0,
            color: [0, 0.5, 1],  // Blue plasma
            pulse: 0.8
        }));

        // Create sphere wireframe
        const sphere = PlasmaWireframe.sphere({
            radius: 1.5,
            latSegments: 12,
            lonSegments: 16,
            color: [0, 1, 0.5],
            glow: 1.0,
            glowRadius: 0.15
        });

        // Create cube wireframe
        const cube = PlasmaWireframe.cube({
            size: 0.5,
            color: [1, 1, 0],
            glow: 0.8,
            glowRadius: 0.1
        });

        // Position cube at orbiting mass
        for (const seg of cube.segments) {
            seg.start = vec3.add(seg.start, vec3.create(1.5, 0, 0));
            seg.end = vec3.add(seg.end, vec3.create(1.5, 0, 0));
        }

        // Mouse interaction
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };
        let rotation = { x: 0.4, y: 0.5 };  // Better initial view angle

        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouse = { x: e.clientX, y: e.clientY };
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - lastMouse.x;
            const dy = e.clientY - lastMouse.y;
            rotation.y += dx * 0.01;
            rotation.x += dy * 0.01;
            renderer.setRotation(rotation.x, rotation.y);
            lastMouse = { x: e.clientX, y: e.clientY };
        });

        canvas.addEventListener('mouseup', () => isDragging = false);
        canvas.addEventListener('mouseleave', () => isDragging = false);

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoom = e.deltaY > 0 ? 1.1 : 0.9;
            renderer.camera.position.z *= zoom;
        }, { passive: false });

        // Control sliders
        const sliders = {
            decay: { target: 'phosphorDecay', el: document.getElementById('decay'), valEl: document.getElementById('decay-val') },
            bloom: { target: 'bloomIntensity', el: document.getElementById('bloom'), valEl: document.getElementById('bloom-val') },
            scanlines: { target: 'scanlineIntensity', el: document.getElementById('scanlines'), valEl: document.getElementById('scanlines-val') },
            pointsize: { target: 'pointSize', el: document.getElementById('pointsize'), valEl: document.getElementById('pointsize-val') }
        };

        for (const [key, slider] of Object.entries(sliders)) {
            slider.el.addEventListener('input', () => {
                const val = parseFloat(slider.el.value);
                renderer.options[slider.target] = val;
                slider.valEl.textContent = val.toFixed(2);
            });
        }

        // Gravity control
        const gravitySlider = document.getElementById('gravity');
        const gravityVal = document.getElementById('gravity-val');
        gravitySlider.addEventListener('input', () => {
            centralMass.mass = parseFloat(gravitySlider.value);
            gravityVal.textContent = centralMass.mass.toFixed(1);
        });

        // Pulse control
        const pulseSlider = document.getElementById('pulse');
        const pulseVal = document.getElementById('pulse-val');
        pulseSlider.addEventListener('input', () => {
            centralMass.pulse = parseFloat(pulseSlider.value);
            orbitMass.pulse = centralMass.pulse * 1.6;
            pulseVal.textContent = centralMass.pulse.toFixed(1);
        });

        // FPS tracking
        let frameCount = 0;
        let lastFpsTime = performance.now();
        const fpsEl = document.getElementById('fps');
        const pointsEl = document.getElementById('points');

        // Animation loop
        let lastTime = performance.now();
        let orbitAngle = 0;

        function animate() {
            const now = performance.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            // Update orbit
            orbitAngle += dt * 0.5;
            orbitMass.position.x = Math.cos(orbitAngle) * 1.8;
            orbitMass.position.z = Math.sin(orbitAngle) * 1.8;

            // Update cube position to follow orbit mass
            const cubeOffset = vec3.sub(orbitMass.position, vec3.create(1.5, 0, 0));
            // (For simplicity, cube stays at original position - would need to update segment positions)

            // Update plasma field
            field.update(dt);

            // Sample glow points
            const spherePoints = sphere.sampleAllGlow(field, 6, 6);
            const cubePoints = cube.sampleAllGlow(field, 4, 4);
            const allPoints = [...spherePoints, ...cubePoints];

            // Upload wireframe lines (so you can see the sphere shape)
            const allSegments = [...sphere.segments, ...cube.segments];
            renderer.uploadLines(allSegments);

            // Upload glow and render
            renderer.uploadGlowPoints(allPoints);
            renderer.render(dt);

            // FPS
            frameCount++;
            if (now - lastFpsTime >= 1000) {
                fpsEl.textContent = `FPS: ${frameCount}`;
                pointsEl.textContent = `Points: ${allPoints.length}`;
                frameCount = 0;
                lastFpsTime = now;
            }

            requestAnimationFrame(animate);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth * window.devicePixelRatio;
            canvas.height = window.innerHeight * window.devicePixelRatio;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            renderer.resize(canvas.width, canvas.height);
        });

        // Start
        renderer.setRotation(rotation.x, rotation.y);
        animate();

        console.log('PlasmaVision initialized');
        console.log('- Sphere wireframe with gravitational glow');
        console.log('- Central orange mass pulls glow inward');
        console.log('- Orbiting blue mass creates asymmetric pull');
    </script>
</body>
</html>
