:root{
  /* Color tokens */
  --color-bg:#0b0c10; --color-fg:#c5c8d4; --color-muted:#8a8f9d;
  --color-accent:#7aa2f7; --color-ok:#8bd5ca; --color-warn:#f6c177; --color-err:#eb6f92;

  /* Surface tokens */
  --surface-0:#0f1320; --surface-1:#12141b; --surface-2:#191c25;
  --surface-stroke:#252a3b; --shadow:0 10px 30px rgba(0,0,0,.35);

  /* Control tokens */
  --radius:12px; --pad:10px; --gap:10px;
  --range-h:28px; --range-track:#23283a; --range-fill:#3a4363; --thumb:#b9c2ff; --thumb-focus:#dbe0ff;
  --val:#8bf18a;

  /* Z & sizing */
  --z-graph:10; --z-panels:20; --z-hud:30; --z-fab:40; --z-cursor:50;
  --panel-width:420px;
}

/* Base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--color-bg);color:var(--color-fg);font:13px/1.35 system-ui,Segoe UI,Roboto,Arial,sans-serif;cursor:default;user-select:none;-webkit-user-select:none}

/* Allow text selection in specific elements */
input,textarea,pre,.kbd,code,[contenteditable]{user-select:text;-webkit-user-select:text;cursor:text}
input[type="range"],input[type="checkbox"],button,select{cursor:pointer}
.panel-header{cursor:grab}
.panel-header:active{cursor:grabbing}
*{scrollbar-width:thin; scrollbar-color:#39405a #141822}
*::-webkit-scrollbar{width:10px;height:10px}
*::-webkit-scrollbar-track{background:#141822}
*::-webkit-scrollbar-thumb{background:#39405a;border-radius:8px;border:2px solid #141822}
*::-webkit-scrollbar-thumb:hover{background:#4a5272}

/* Graph canvas occupies base layer */
#bus-canvas{position:fixed;inset:0;z-index:var(--z-graph);background:var(--surface-0)}

/* HUD */
#hud{position:fixed;left:12px;right:12px;top:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;z-index:var(--z-hud)}
.hud-left,.hud-right{display:flex;gap:8px;align-items:center}
.badge{background:#1a1f2b;border:1px solid #30364a;border-radius:10px;padding:6px 10px;color:#cbd3ea}
.btn-solid{background:var(--color-accent);color:#0b0c10;border:1px solid #0b0c10;border-radius:10px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
.btn-ghost{background:#25304e;color:#cbd3ea;border:1px solid #334166;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn-ghost.small{padding:4px 8px;font-size:12px}

/* FABs (with active state) */
#fab-stack{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:var(--z-fab)}
.fab{background:#1a1f2b;border:1px solid #30364a;border-radius:999px;padding:12px 14px;color:#cbd3ea;cursor:pointer;box-shadow:var(--shadow);opacity:.9;transition:all .2s ease}
.fab:hover{opacity:1;transform:scale(1.05)}
.fab.fab--active{background:#7aa2f7;color:#0b0c10;border-color:#7aa2f7;opacity:1}

/* Panels (non-modal floating cards with three display modes) */
.panel{position:fixed;background:var(--surface-1);border:1px solid var(--surface-stroke);border-radius:var(--radius);box-shadow:var(--shadow);z-index:var(--z-panels);min-width:320px;min-height:200px;transition:all .3s ease}
.panel.panel--closed{display:none}
.panel.panel--open{display:block}
.panel.panel--fullscreen{left:20px !important;top:60px !important;width:calc(100vw - 100px) !important;height:calc(100vh - 80px) !important}
.panel.panel--fullscreen .panel-body{max-height:calc(100vh - 140px)}

/* Resize handle */
.panel-resize-handle{position:absolute;right:0;bottom:0;width:20px;height:20px;cursor:nwse-resize;z-index:10}
.panel-resize-handle::after{content:"";position:absolute;right:2px;bottom:2px;width:12px;height:12px;border-right:2px solid #3a4a7a;border-bottom:2px solid #3a4a7a;opacity:0.6}
.panel-resize-handle:hover::after{opacity:1;border-color:#7aa2f7}
.panel.panel--fullscreen .panel-resize-handle{display:none}

/* Panel structure */
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--surface-stroke);background:#0e1220;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);cursor:grab}
.panel-header:active{cursor:grabbing}
.panel.panel--fullscreen .panel-header{cursor:default}
.panel-body{padding:10px;display:grid;gap:10px;max-height:50vh;overflow:auto}
.panel-title{color:#cfe1ff;font-weight:700}
.panel-actions{display:flex;gap:6px;align-items:center}
.card{background:#0c111d;border:1px solid #262c40;border-radius:var(--radius);padding:10px}

/* Panel mode controls */
.panel-mode-controls{display:flex;gap:4px;align-items:center}
.btn-mode{width:22px;height:22px;padding:4px;background:transparent;border:1px solid #3a4a7a;border-radius:6px;color:#7aa2f7;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
.btn-mode:hover{background:#1a2540;border-color:#5e7ae0}
.btn-mode.btn-close:hover{background:#3a1a1a;border-color:#eb6f92;color:#eb6f92}
.btn-mode.btn-maximize:hover{background:#1a2a40;border-color:#8bd5ca;color:#8bd5ca}
.btn-mode svg{width:12px;height:12px}

/* Controls */
.cl-fs{border:1px solid #262a36;border-radius:var(--radius);padding:10px;background:linear-gradient(180deg,#111521,#0c101a)}
.cl-fs legend{color:#9fb2e0;padding:0 6px}
.row{display:grid;grid-template-columns:1fr 160px;align-items:center;gap:10px;margin:6px 0}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.val{color:var(--val);font-variant-numeric:tabular-nums}

/* Responsive control layouts */
.panel-body.layout-wide .grid2{grid-template-columns:1fr 1fr}
.panel-body.layout-narrow .grid2{grid-template-columns:1fr}
.panel-body.layout-narrow .row{grid-template-columns:1fr 140px;margin:4px 0}
.panel-body.layout-compact .grid2{grid-template-columns:1fr}
.panel-body.layout-compact .row{grid-template-columns:1fr;margin:2px 0}
.panel-body.layout-compact .row label{font-size:11px}
.panel-body.layout-compact .row input[type=range]{height:20px}
.panel-body.layout-compact .val{font-size:11px}

/* Range styling */
input[type=range]{appearance:none;height:var(--range-h);background:transparent}
input[type=range]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg,var(--range-track),var(--range-fill));border-radius:6px}
input[type=range]::-webkit-slider-thumb{appearance:none;margin-top:-6px;width:18px;height:18px;border-radius:10px;background:var(--thumb);border:2px solid #0b0c10;box-shadow:0 0 0 2px rgba(122,162,247,.15)}
input[type=range]:focus::-webkit-slider-thumb{background:var(--thumb-focus)}
input[type=range]::-moz-range-track{height:6px;background:linear-gradient(90deg,var(--range-track),var(--range-fill));border-radius:6px}
input[type=range]::-moz-range-thumb{width:18px;height:18px;border:none;border-radius:10px;background:var(--thumb)}

/* Scope and Gamepad Visualizations */
.scope{background:#0a0b12;border:1px solid #222;border-radius:var(--radius)}
.gp-viz{background:#0a0b12;border:1px solid #222;border-radius:var(--radius);display:block}

/* Meter */
.meter{height:10px;background:var(--surface-2);border-radius:6px;overflow:hidden}
.meter-bar{height:100%;width:0;background:linear-gradient(90deg,var(--color-ok),var(--color-accent))}

/* Tables */
.map-table,.log-table{width:100%;border-collapse:separate;border-spacing:0 6px;table-layout:fixed}
.map-table th,.map-table td,.log-table th,.log-table td{padding:6px 8px;background:#0c111d;border:1px solid #262c40}
.map-table th,.log-table th{color:#b7c6ea;font-weight:600}

/* Mapper table column widths */
.map-table th:nth-child(1),.map-table td:nth-child(1){width:90px}
.map-table th:nth-child(2),.map-table td:nth-child(2){width:110px}
.map-table th:nth-child(3),.map-table td:nth-child(3){width:60px}
.map-table th:nth-child(4),.map-table td:nth-child(4){width:70px}
.map-table th:nth-child(5),.map-table td:nth-child(5){width:70px}
.map-table th:nth-child(6),.map-table td:nth-child(6){width:40px}
.map-table th:nth-child(7),.map-table td:nth-child(7){width:60px}
.map-table th:nth-child(8),.map-table td:nth-child(8){width:40px}

/* Rhythm table column widths (applies to #rhythm-body's parent) */
#panel-rhythm .map-table th:nth-child(1),#panel-rhythm .map-table td:nth-child(1){width:120px} /* Param */
#panel-rhythm .map-table th:nth-child(2),#panel-rhythm .map-table td:nth-child(2){width:90px}  /* Rate */
#panel-rhythm .map-table th:nth-child(3),#panel-rhythm .map-table td:nth-child(3){width:90px}  /* Wave */
#panel-rhythm .map-table th:nth-child(4),#panel-rhythm .map-table td:nth-child(4){width:70px}  /* Depth */
#panel-rhythm .map-table th:nth-child(5),#panel-rhythm .map-table td:nth-child(5){width:70px}  /* Phase */
#panel-rhythm .map-table th:nth-child(6),#panel-rhythm .map-table td:nth-child(6){width:40px}  /* Del */
.log-table.tight{font:12px ui-monospace,monospace}
.log-table.tight th,.log-table.tight td{text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-table.tight td.chg{color:#cfe1ff;font-weight:700}
#params-json{width:100%;height:140px;background:#0a0f1a;border:1px solid #262c40;border-radius:8px;color:#bcd}

/* Token inputs */
#tokens-grid input[type="text"]{width:100%;background:#0a0f1a;border:1px solid #262c40;border-radius:6px;padding:4px 8px;color:#cbd3ea;font:12px ui-monospace,monospace}
#tokens-grid input[type="text"]:focus{outline:none;border-color:#7aa2f7;background:#0c111d}

/* Cursor */
#gp-cursor{position:fixed;left:0;top:0;width:14px;height:14px;border:2px solid #b7c6ea;border-radius:50%;pointer-events:none;opacity:.9;transform:translate(-7px,-7px);z-index:var(--z-cursor);box-shadow:0 0 0 2px rgba(122,162,247,.15)}

/* Component hover state for gamepad */
[data-param].gp-hover{box-shadow:0 0 0 2px rgba(122,162,247,0.4);transition:box-shadow .15s ease}
[data-param].gp-selected{outline:2px solid #7aa2f7 !important;outline-offset:2px !important}

/* Inline */
.row-inline{display:flex;align-items:center;gap:6px;color:#cbd3ea}
.row-inline.small{font-size:12px}

/* Small select dropdown */
.small-select{background:#1a1f2b;border:1px solid #30364a;border-radius:6px;padding:3px 6px;color:#cbd3ea;font-size:12px;cursor:pointer}
.small-select:hover{border-color:#3a4a7a}
.small-select:focus{outline:none;border-color:#7aa2f7}

/* Input fields - dark theme */
input[type="text"],input[type="number"],select{background:#0a0f1a;border:1px solid #262c40;border-radius:6px;padding:4px 8px;color:#cbd3ea;font-size:12px}
input[type="text"]:focus,input[type="number"]:focus,select:focus{outline:none;border-color:#7aa2f7;background:#0c111d}
input[type="text"]:hover,input[type="number"]:hover,select:hover{border-color:#3a4a7a}

/* Table button styling - smaller, transparent trash icons */
.map-table button,.log-table button{background:transparent;border:none;color:#8a8f9d;font-size:16px;cursor:pointer;padding:2px 4px;opacity:0.6;transition:all .2s ease}
.map-table button:hover,.log-table button:hover{opacity:1;color:#eb6f92;transform:scale(1.1)}

/* Table inputs should also be dark */
.map-table input[type="number"],.map-table input[type="text"],.map-table select{background:#0a0f1a;border:1px solid #262c40;border-radius:4px;padding:3px 6px;color:#cbd3ea;font-size:11px;width:100%}
.map-table input[type="number"]:focus,.map-table input[type="text"]:focus,.map-table select:focus{outline:none;border-color:#7aa2f7;background:#0c111d}
.map-table input[type="checkbox"]{width:auto;cursor:pointer}

/* Headings inside cards */
h3{margin:0 0 6px;font-size:12px;color:#93a8d6}

/* Collapsible details */
details{user-select:none}
details summary{list-style:none}
details summary::-webkit-details-marker{display:none}
details summary::before{content:'â–¶ ';display:inline-block;transition:transform .2s}
details[open] summary::before{transform:rotate(90deg)}

/* Utility */
.kbd{font:12px ui-monospace,monospace;color:#aab;white-space:pre-wrap;word-break:break-word}


/* MIDI Controller Template Styles */
.midi-template-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:8px;background:#0a0f1a;border:1px solid #1e2a40;border-radius:6px}

.midi-template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:16px}

.midi-track{background:#0a0f1a;border:1px solid #1e2a40;border-radius:6px;padding:8px}
.midi-track-header{text-align:center;font-weight:bold;font-size:11px;color:#8bd5ca;margin-bottom:8px}

.midi-control-slot{background:#131820;border:1px solid #262c40;border-radius:4px;padding:8px;text-align:center;font-size:11px;color:#6b7089;cursor:pointer;transition:all .2s;min-height:32px;display:flex;align-items:center;justify-content:center;margin-bottom:4px}

.midi-control-slot:hover{border-color:#7aa2f7;background:#1a2030;color:#cbd3ea}

.midi-control-slot.midi-assigned{border-color:#eb6f92;background:#1a0e14;color:#eb6f92}

.midi-control-slot.midi-learning{border-color:#f6c177;background:#1a1510;color:#f6c177;animation:pulse 1s infinite}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

.midi-button-group{display:grid;grid-template-columns:repeat(2,1fr);gap:4px}

.midi-button{padding:6px;font-size:10px;min-height:28px}

.midi-transport-grid,.midi-global-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:8px}

.midi-profile-item{display:flex;align-items:center;padding:8px;background:#0a0f1a;border:1px solid #1e2a40;border-radius:6px;margin-bottom:6px;transition:all .2s}

.midi-profile-item:hover{border-color:#7aa2f7;background:#0c111d}

.midi-profile-item.active{border-color:#8bd5ca;background:#0e1a1a}

