# VT100 Controls Architecture

## System Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    config/vt100-config.js                   │
│                  SINGLE SOURCE OF TRUTH                     │
│                                                             │
│  VT100_EFFECTS = [                                          │
│    { id, label, min, max, step, default, unit, ... },       │
│    ...                                                      │
│  ]                                                          │
│                                                             │
│  QUICK_SETTINGS_DEFAULTS = ['glow', 'scanlines', ...]      │
│  VT100_MENU_EFFECTS = ['glow', 'scanlines', 'wave']        │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ imports
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   CLI/UI     │   │   Modules    │   │   Commands   │
│              │   │              │   │              │
│ • quick-     │   │ • vt100-     │   │ • command-   │
│   settings   │   │   effects    │   │   processor  │
│ • vt100-     │   │              │   │ • tab-       │
│   params     │   │              │   │   completion │
│ • settings-  │   │              │   │              │
│   generator  │   │              │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
```

## Data Flow

```
User Action (any UI)
        │
        ▼
┌────────────────────────────────────────┐
│   vt100Effects.setEffect(id, value)    │
│   (modules/vt100-effects.js)           │
└────────────────────────────────────────┘
        │
        ├─────────────────────────────────┐
        │                                 │
        ▼                                 ▼
┌──────────────────┐            ┌──────────────────┐
│  Update CSS      │            │  Update Canvas   │
│  Variables       │            │  Renderer        │
│  (CLI Panel)     │            │  (Vecterm Demo)  │
└──────────────────┘            └──────────────────┘
        │                                 │
        └─────────────────┬───────────────┘
                          │
                          ▼
                ┌──────────────────┐
                │  Sync UI         │
                │  Controls        │
                │  (if needed)     │
                └──────────────────┘
```

## Three UI Panels

### 1. Quick Settings (Right Sidebar)

**Location**: Right side of screen
**Trigger**: Always visible when has sliders
**Effects Shown**: All effects in `QUICK_SETTINGS_DEFAULTS`

```
┌────────────────────────────┐
│ ⚡ Quick Settings       − │
├────────────────────────────┤
│ glow     [═══○═════]  0.30 │
│ scanlines[═══○═════]  0.41 │
│ scanspeed[═══○═════]  8s   │
│ wave     [═══○═════]  2px  │
│ border   [═══○═════]  0.40 │
└────────────────────────────┘
```

**Data-driven**: Uses `QUICK_SETTINGS_DEFAULTS` from config

### 2. VT100 Hamburger Menu (Terminal Overlay)

**Location**: Center of CLI terminal
**Trigger**: Click ☰ icon in terminal
**Effects Shown**: Subset in `VT100_MENU_EFFECTS`

```
┌────────────────────────────┐
│ PHOSPHOR GLOW              │
│ [═══════○═══]  0.30        │
│                            │
│ SCANLINES                  │
│ [═══════○═══]  0.15        │
│                            │
│ RASTER WAVE                │
│ [═══════○═══]  2px         │
└────────────────────────────┘
```

**Data-driven**: Dynamically generated from `VT100_MENU_EFFECTS`

### 3. Settings Panel (Main Settings)

**Location**: Overlay panel, top-right
**Trigger**: Click ⚙ icon in top bar
**Effects Shown**: All effects in `VT100_EFFECTS`

```
┌────────────────────────────┐
│ [ QUICK SETTINGS ]      × │
├────────────────────────────┤
│ VT100 Effects              │
│                            │
│ Phosphor Glow:             │
│ [═══○═════] 0.30           │
│                            │
│ Scanlines:                 │
│ [═══○═════] 0.15           │
│                            │
│ Scan Speed:                │
│ [═══○═════] 8s             │
│                            │
│ Raster Wave:               │
│ [═══○═════] 2px            │
│                            │
│ Wave Speed:                │
│ [═══○═════] 3s             │
│                            │
│ Border Glow:               │
│ [═══○═════] 0.40           │
└────────────────────────────┘
```

**Data-driven**: Generated by `settings-vt100-generator.js` from all `VT100_EFFECTS`

## Effect Configuration Flow

```
Adding New Effect:

1. Add to VT100_EFFECTS in config/vt100-config.js
   {
     id: 'neweffect',
     label: 'New Effect',
     min: 0,
     max: 1,
     step: 0.05,
     default: 0.5,
     unit: '',
     description: 'Does something cool',
     cssVar: '--vt100-neweffect',
     category: 'visual'
   }

2. (Optional) Add to QUICK_SETTINGS_DEFAULTS or VT100_MENU_EFFECTS

3. Add CSS variable handling in modules/vt100-effects.js
   case 'neweffect':
     cliPanel.style.setProperty('--vt100-neweffect', value);
     break;

4. Effect now appears in:
   ✓ vt100.help
   ✓ vt100.status
   ✓ vt100.neweffect <value>
   ✓ Tab completion
   ✓ Settings panel
   ✓ Quick Settings (if in defaults)
   ✓ Hamburger menu (if in menu effects)
```

## Before vs After

### Before (Scattered Config)

```
cli/tab-completion.js:
  'vt100.glow': { min: 0, max: 1, step: 0.05, default: 0.4 }

cli/command-processor.js:
  if (action === 'glow') {
    cliLog('vt100.glow <0-2> - Phosphor glow (default: 0.3)');
  }

modules/vt100-effects.js:
  this.effects = { glow: 0.3, ... };

index.html:
  <input type="range" id="glow-intensity" min="0" max="2" step="0.05" value="0.3">
```

**Problems**: Inconsistent defaults (0.3 vs 0.4), inconsistent ranges (0-1 vs 0-2)

### After (Centralized Config)

```
config/vt100-config.js:
  {
    id: 'glow',
    label: 'Phosphor Glow',
    min: 0,
    max: 2,
    step: 0.05,
    default: 0.3,
    unit: '',
    description: 'Phosphor glow intensity...',
    cssVar: '--vt100-border-glow',
    category: 'visual'
  }

All files import from config - guaranteed consistency!
```

## Command Reference

All commands are auto-generated from `VT100_EFFECTS`:

```bash
vt100.help         # Show all effects with ranges
vt100.status       # Show current values
vt100.reset        # Reset to defaults

vt100.glow         # Get current glow
vt100.glow 0.5     # Set glow to 0.5

vt100.scanlines    # Get current scanlines
vt100.scanlines 0.2 # Set scanlines

vt100.scanspeed    # Get current scan speed
vt100.wave         # Get current wave
vt100.wavespeed    # Get current wave speed
vt100.border       # Get current border glow
```

## Integration Points

### CSS Variables

Effects are applied via CSS custom properties on `#cli-panel`:

```css
#cli-panel {
  --vt100-border-glow: 0.3;
  --vt100-scanline-intensity: 0.15;
  --vt100-scanline-speed: 8s;
  --vt100-wave-amplitude: 2px;
  --vt100-wave-speed: 3s;
  --vt100-glow-intensity: 0.4;
}
```

### Canvas Renderer

Effects also apply to Vecterm canvas renderer:

```javascript
vectermRenderer.config.glowIntensity = value;
vectermRenderer.config.scanlineIntensity = value;
vectermRenderer.config.scanlineSpeed = value;
```

### MIDI Control

Effects can be controlled via MIDI using `createMidiMappingConfig()`:

```javascript
import { createMidiMappingConfig } from './config/vt100-config.js';

const midiMap = createMidiMappingConfig();
// Returns { 'vt100.glow': { min, max, step, unit, type }, ... }
```
